<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn Dashboard</title>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #fafbfc;
            color: #232526;
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        .center-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.1;
            color: #232526;
            margin: 0;
            white-space: nowrap;
        }
        
        .title-text {
            color: #232526;
        }
        
        .title-highlight {
            color: #2563eb;
        }
        
        .title-word {
            display: inline-block;
            margin-right: 6px;
            font-weight: 700;
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
            letter-spacing: 1px;
        }
        
        .title-word.ranked {
            color: #2c3e50;
            animation-delay: 0.1s;
        }
        
        .title-word.war {
            color: #8e44ad;
            animation-delay: 0.2s;
        }
        
        .title-word.bookie {
            color: #34495e;
            animation-delay: 0.3s;
        }
        
        .beta-badge {
            position: absolute;
            top: -15px;
            right: -20px;
            background: rgba(52, 73, 94, 0.1);
            color: #7f8c8d;
            font-size: 0.7rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            letter-spacing: 0.5px;
            border: 1px solid rgba(52, 73, 94, 0.2);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .title-word:hover {
            transform: scale(1.05);
            transition: transform 0.3s ease;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .call-to-action {
            font-size: 1rem;
            color: #2563eb;
            font-weight: 500;
            margin-bottom: 0;
        }
        
        .info-message {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 12px;
            text-align: center;
            line-height: 1.4;
        }
        

        
        .login-form {
            width: 100%;
            max-width: 400px;
        }
        .center-box h2 {
            font-size: 1.35rem;
            font-weight: 500;
            margin-bottom: 28px;
            letter-spacing: -0.2px;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
        }
        .api-input {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .api-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1.2px solid #e3e6ea;
            border-radius: 8px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            font-size: 15px;
            background: #f6f8fa;
            color: #232526;
            transition: all 0.2s cubic-bezier(.4,0,.2,1);
        }
        .api-input input:focus {
            outline: none;
            border-color: #232526;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(35,37,38,0.08);
        }
        .api-input button {
            padding: 12px 28px;
            background: linear-gradient(90deg, #232526 0%, #414345 100%);
            color: #fff;
            border: none;
            border-radius: 22px;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 2px 8px rgba(35,37,38,0.07);
            letter-spacing: 0.01em;
            position: relative;
        }
        .api-input button:hover, .api-input button:focus {
            background: linear-gradient(90deg, #414345 0%, #232526 100%);
            box-shadow: 0 6px 18px rgba(35,37,38,0.13);
            transform: translateY(-1px) scale(1.04);
        }
        .error-message {
            color: #e63946;
            font-size: 0.98rem;
            margin-top: 18px;
            min-height: 22px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            letter-spacing: -0.2px;
        }
        .success-message {
            color: #16a34a;
            font-size: 1.05rem;
            margin-top: 22px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            letter-spacing: -0.2px;
            text-align: center;
        }
        /* Management System Styles */
        .dashboard {
            width: 100vw;
            height: 100vh;
            background: #fafbfc;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border-bottom: 1px solid #ececec;
            padding: 0 20px;
            min-height: 60px;
            gap: 20px;
        }

        .dashboard-tabs {
            display: flex;
            gap: 0;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border-bottom: 1px solid #ececec;
            padding: 0 20px;
            min-height: 60px;
            gap: 20px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .dashboard-header.hidden {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
            height: 0;
            min-height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
            padding-right: 20px;
        }

        .user-info-section {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            min-width: 250px;
            max-width: 350px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .user-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.85rem;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-level {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            line-height: 1.1;
        }

        .user-faction {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            line-height: 1.1;
        }

        .logout-btn {
            background: #ef4444;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }
        .dashboard-tab {
            padding: 18px 36px;
            font-size: 1rem;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-weight: 500;
            color: #232526;
            background: none;
            border: none;
            border-bottom: 2.5px solid transparent;
            cursor: pointer;
            transition: all 0.18s cubic-bezier(.4,0,.2,1);
            min-height: 44px; /* Touch-friendly minimum size */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .dashboard-tab.active {
            border-bottom: 2.5px solid #232526;
            color: #232526;
            background: #f6f8fa;
        }
        .dashboard-tab:not(.active):hover {
            background: #f6f8fa;
        }
        .dashboard-content {
            flex: 1;
            padding: 40px 32px 0 32px;
            width: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .in-progress {
            text-align: center;
            color: #888;
            font-size: 1.2rem;
            margin-top: 80px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
        }
        
        /* Torn Colosseum Platform Styles */
        .betting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .betting-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #232526;
        }

        .betting-controls {
            display: flex;
                gap: 12px;
            align-items: center;
        }

        .betting-info {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .betting-info p {
            margin: 0;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.5;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
        }

        .betting-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        
        .search-container {
            width: auto;
            max-width: 300px;
        }
        
        .faction-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            background: white;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .faction-search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .faction-search-input::placeholder {
            color: #9ca3af;
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
        }
        
        .filter-tab:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .filter-tab.active {
            background: #232526;
            color: white;
            border-color: #232526;
        }

        .betting-stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .betting-stat-card h3 {
            color: #6b7280;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .betting-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #232526;
        }

        .betting-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .betting-card {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            border-top: 2px solid #28a745;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: 12px;
        }

        .betting-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .betting-card-header {
            padding: 12px 14px 8px 14px;
            background: transparent;
            position: relative;
        }

        .war-id {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 3px;
        }

        .lead-target {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .status-tag {
            position: absolute;
            top: 16px;
            right: 18px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-tag.upcoming {
            background: #fef3c7;
            color: #92400e;
        }

        .status-tag.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-tag.finished {
            background: #e5e7eb;
            color: #374151;
        }

        .countdown-timer {
            background: #fef3c7;
            padding: 6px 12px;
            border-radius: 6px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .start-datetime {
            background: #f0f9ff;
            color: #0369a1;
            padding: 6px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timer-icon {
            font-size: 0.8rem;
        }

        .timer-text {
            font-size: 0.8rem;
            font-weight: 500;
            color: #92400e;
        }

        .betting-card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .betting-card-status.active {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .betting-card-status.finished {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .betting-card-status.preparing {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .betting-card-content {
            padding: 12px 14px;
        }

        .faction-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .faction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .faction-info {
            flex: 1;
        }

        .faction-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 1px;
        }
        
        .faction-name a {
            color: inherit;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .faction-name a:hover {
            color: #1e7e34;
            text-decoration: underline;
        }

        .faction-stats {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .faction-odds {
            text-align: right;
        }

        .odds-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 1px;
        }

        .odds-money {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .betting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        .betting-option:hover {
            border-color: #059669;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);
        }

        .betting-option.selected {
            border-color: #059669;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .betting-option-left {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .betting-option-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.9rem;
            letter-spacing: -0.025em;
        }

        .betting-option-name a {
            color: #059669;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .betting-option-name a:hover {
            color: #047857;
            text-decoration: none;
        }

        .betting-option-name a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: #047857;
            transition: width 0.2s ease;
        }

        .betting-option-name a:hover::after {
            width: 100%;
        }

        .betting-option-details {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }

        .betting-option-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .betting-odds {
            font-size: 1.1rem;
            font-weight: 800;
            color: #059669;
            margin-bottom: 2px;
            letter-spacing: -0.025em;
        }

        .betting-returns {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }

        .betting-card-footer {
            padding: 10px 14px;
            border-top: 1px solid #e9ecef;
            background: transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .betting-info {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            color: #6c757d;
        }

        .money-bag {
            font-size: 0.9rem;
        }

        .no-bets {
            color: #6c757d;
        }

        .place-bet-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .place-bet-btn:hover {
            background: #218838;
        }

        .betting-action-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);
            letter-spacing: 0.025em;
        }

        .betting-action-btn:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        .betting-action-btn:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .betting-actions {
            display: flex;
            align-items: center;
        }

        .betting-report-link {
            padding: 8px 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .betting-report-link:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            text-decoration: none;
            color: white;
        }

        .betting-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .betting-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .betting-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .betting-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #232526;
        }

        .betting-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .betting-modal-close:hover {
            background: #f3f4f6;
            color: #232526;
        }

        .betting-form-group {
            margin-bottom: 16px;
        }

        .betting-form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #232526;
            margin-bottom: 8px;
        }

        .betting-form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .betting-form-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .betting-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .betting-form-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .betting-form-btn-primary {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .betting-form-btn-primary:hover {
            background: linear-gradient(135deg, #047857, #059669);
        }

        .betting-form-btn-secondary {
            background: #f3f4f6;
            color: #6b7280;
        }

        .betting-form-btn-secondary:hover {
            background: #e5e7eb;
        }

        .betting-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #166534;
        }

        .betting-message.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .betting-copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .betting-copy-btn:hover {
            background: #2563eb;
        }

        .betting-copy-btn:active {
            transform: scale(0.95);
        }

        .betting-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            margin-top: 8px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .betting-timer.countdown {
            animation: pulse 2s infinite;
        }

        .betting-timer.duration {
            animation: subtle-glow 3s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        @keyframes subtle-glow {
            0%, 100% {
                box-shadow: 0 0 0 rgba(5, 150, 105, 0);
            }
            50% {
                box-shadow: 0 0 8px rgba(5, 150, 105, 0.3);
            }
        }

        .betting-timer.countdown {
            background: #fef3c7;
            color: #92400e;
        }

        .betting-timer.duration {
            background: #dcfce7;
            color: #166534;
        }

        .betting-timer.finished {
            background: #f3f4f6;
            color: #6b7280;
        }

        .betting-timer-icon {
            font-size: 1rem;
        }

        @media (max-width: 1400px) {
            .betting-grid {
            grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            .betting-grid {
            grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                height: 100vh;
                overflow-x: hidden;
            }
            
            .dashboard-header {
                flex-wrap: wrap;
                padding: 0;
            }
            
            .dashboard-tab {
                flex: 1;
                min-width: 0;
                padding: 16px 12px;
                font-size: 0.9rem;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .dashboard-content {
                padding: 20px 16px 0 16px;
                overflow-x: hidden;
            }
            
            .betting-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .betting-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .betting-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .betting-filters {
                gap: 12px;
            }
            
            .faction-search-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .filter-tabs {
                gap: 6px;
            }
            
            .filter-tab {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            
            .betting-controls .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            .betting-title {
                font-size: 1.3rem;
            }
            
            .betting-info {
                padding: 12px 16px;
                margin-bottom: 20px;
            }
            
            .betting-info p {
                font-size: 0.85rem;
                line-height: 1.4;
            }
            
            .betting-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .betting-stat-card {
                padding: 12px;
            }
            
            .betting-stat-card .value {
                font-size: 1.3rem;
            }
            
            .betting-card {
                padding: 16px;
            }
            
            .betting-card-header {
                padding: 12px 16px;
            }
            
            .betting-card-title {
                font-size: 0.9rem;
            }
            
            .betting-card-content {
                padding: 14px 16px;
            }
            
            .betting-option {
                padding: 10px 12px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .betting-option-left {
                text-align: center;
            }
            
            .betting-option-right {
                text-align: center;
                align-items: center;
            }
            
            .betting-odds {
                font-size: 1rem;
            }
            
            .betting-card-footer {
                padding: 12px 16px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .betting-action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .betting-modal-content {
                width: 95%;
                max-width: none;
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .betting-modal-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .betting-modal-title {
                font-size: 1.1rem;
            }
            
            .betting-form-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .betting-form-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .betting-form-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-tab {
                padding: 14px 8px;
                font-size: 0.8rem;
            }
            
            .dashboard-content {
                padding: 16px 12px 0 12px;
            }
            
            .betting-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .betting-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .betting-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .betting-stat-card {
                padding: 10px;
            }
            
            .betting-stat-card .value {
                font-size: 1.2rem;
            }
            
            .betting-card {
                padding: 12px;
            }
            
            .betting-card-title {
                font-size: 1rem;
            }
            
            .betting-modal-content {
                width: 98%;
                margin: 10px;
                padding: 16px;
            }
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            min-height: 44px; /* Touch-friendly minimum size */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* War Logs Styles */
        .warlogs-controls {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .warlogs-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #232526;
        }

        .warlogs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            overflow: hidden;
        }

        .war-card {
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
            transition: all 0.2s;
        }

        .war-card:hover {
            background: #f9fafb;
        }

        .war-card:last-child {
            border-bottom: none;
        }

        .war-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .war-id {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .war-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .war-status.active {
            background: #dcfce7;
            color: #166534;
        }

        .war-status.finished {
            background: #f3f4f6;
            color: #6b7280;
        }

        .war-status.preparing {
            background: #fef3c7;
            color: #92400e;
        }

        .war-factions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
        }

        .war-faction {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .war-faction.winner {
            border-color: #059669;
            background: #f0fdf4;
        }

        .faction-name {
            font-weight: 600;
            color: #232526;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .faction-score {
            font-size: 1.2rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 4px;
        }

        .faction-details {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .war-meta {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: #6b7280;
            flex-wrap: wrap;
        }

        .war-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @media (max-width: 768px) {
            .war-factions {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .war-meta {
                flex-direction: column;
                gap: 8px;
            }
            
            .warlogs-controls {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .warlogs-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-card .value {
                font-size: 1.5rem;
            }
            
            .war-card {
                padding: 16px;
            }
            
            .war-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .war-factions {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .war-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .warlogs-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card .value {
                font-size: 1.3rem;
            }
            
            .war-card {
                padding: 12px;
            }
        }
        
        /* User Bet Tracking Styles */
        .user-betting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .user-betting-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #232526;
        }

        .user-betting-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .user-bets-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .user-bet-stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .user-bet-stat-card h3 {
            color: #6b7280;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .user-bet-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #232526;
        }

        .user-bet-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .user-bet-card:hover {
            box-shadow: 0 4px 16px rgba(35,37,38,0.08);
            transform: translateY(-1px);
        }

        .user-bet-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-bet-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #232526;
        }

        .user-bet-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-bet-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .user-bet-status.confirmed {
            background: #dbeafe;
            color: #1e40af;
        }

        .user-bet-status.won {
            background: #dcfce7;
            color: #166534;
        }

        .user-bet-status.lost {
            background: #fee2e2;
            color: #dc2626;
        }

        .user-bet-status.paid {
            background: #f0fdf4;
            color: #059669;
        }

        .user-bet-content {
            padding: 20px;
        }

        .user-bet-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .user-bet-detail {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-bet-detail-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-bet-detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #232526;
        }

        .user-bet-war-status {
            margin-top: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .user-bet-war-status-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
        }

        .user-bet-war-status-icon {
            font-size: 1.1rem;
        }

        .user-bet-war-status-text {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-bet-scores {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-bet-score-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #f3f4f6;
        }

        .user-bet-score-faction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .user-bet-score-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }

        .user-bet-score-value {
            font-weight: 600;
            font-size: 0.9rem;
            color: #f59e0b;
        }

        .user-faction .user-bet-score-value {
            color: #059669;
        }

        .opponent-faction .user-bet-score-value {
            color: #dc2626;
        }

        .user-bet-score-progress {
            flex: 1;
            max-width: 100px;
        }

        .user-bet-progress-bar {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
        }

        .user-bet-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .user-bet-target {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #eff6ff;
            border-radius: 4px;
            border: 1px solid #dbeafe;
        }

        .user-bet-target-label {
            font-size: 0.8rem;
            color: #3b82f6;
            font-weight: 500;
        }

        .user-bet-target-value {
            font-size: 0.8rem;
            color: #1d4ed8;
            font-weight: 600;
        }

        .user-bet-live-timestamp {
            margin-top: 8px;
            padding: 4px 8px;
            background: #f0fdf4;
            border-radius: 4px;
            border: 1px solid #bbf7d0;
            text-align: center;
        }

        .user-bet-live-timestamp-text {
            font-size: 0.7rem;
            color: #059669;
            font-weight: 500;
        }

        .user-bet-lead-info {
            margin-top: 8px;
            padding: 6px 8px;
            background: #fef3c7;
            border-radius: 4px;
            border: 1px solid #f59e0b;
            text-align: center;
        }

        .user-bet-lead-info-text {
            font-size: 0.8rem;
            color: #92400e;
            font-weight: 600;
        }

        .user-bet-detail-value a {
            color: #059669;
            text-decoration: none;
        }

        .user-bet-detail-value a:hover {
            text-decoration: underline;
        }

        .user-bet-payout {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .user-bet-payout-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #166534;
            margin-bottom: 8px;
        }

        .user-bet-payout-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #059669;
        }

        .user-bet-payout-status {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .user-bet-payout-status.paid {
            color: #059669;
            font-weight: 600;
        }

        .user-bet-payout-status.pending {
            color: #f59e0b;
            font-weight: 600;
        }

        .user-bet-message {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #374151;
        }

        .user-bet-actions {
            padding: 16px 20px;
            border-top: 1px solid #f3f4f6;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-bet-time {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .user-bet-buttons {
            display: flex;
            gap: 8px;
        }

        .user-bet-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-bet-btn-primary {
            background: #059669;
            color: white;
        }

        .user-bet-btn-primary:hover {
            background: #047857;
        }

        .user-bet-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .user-bet-btn-secondary:hover {
            background: #4b5563;
        }

        .user-bet-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .no-bets-message {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-bets-message h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .no-bets-message p {
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .user-betting-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .user-betting-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .user-betting-controls .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            .user-betting-title {
                font-size: 1.3rem;
            }
            
            .user-bets-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .user-bet-stat-card {
                padding: 12px;
            }
            
            .user-bet-stat-card .value {
                font-size: 1.3rem;
            }
            
            .user-bet-card {
                margin-bottom: 12px;
            }
            
            .user-bet-header {
                padding: 12px 16px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .user-bet-title {
                font-size: 1rem;
            }
            
            .user-bet-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .user-bet-actions {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .user-bet-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .center-box {
                max-width: 100%;
                padding: 16px;
            }
            
            .main-title {
                font-size: 1.8rem;
            }
            
            .title-word {
                margin-right: 4px;
                letter-spacing: 0.5px;
            }
            
            .beta-badge {
                top: -12px;
                right: -15px;
                font-size: 0.6rem;
                padding: 3px 6px;
            }
            

            
            .user-betting-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .user-betting-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .user-bets-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .user-bet-stat-card {
                padding: 10px;
            }
            
            .user-bet-stat-card .value {
                font-size: 1.2rem;
            }
            
            .user-bet-header {
                padding: 10px 12px;
            }
            
            .user-bet-title {
                font-size: 0.9rem;
            }
        }

        /* Bet Tracking Styles */
        .bet-tracking-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            margin-top: 24px;
            overflow: hidden;
        }

        .bet-tracking-header {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bet-tracking-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .bet-tracking-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .bet-tracking-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .bet-tracking-content {
            display: none;
            padding: 24px;
        }

        .bet-tracking-content.active {
            display: block;
        }

        /* Compact Stats Grid */
        .compact-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .compact-stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .compact-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .compact-stat-card h4 {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .compact-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .compact-stat-change {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .compact-stat-change.positive {
            background: #dcfce7;
            color: #166534;
        }

        .compact-stat-change.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .compact-stat-change.neutral {
            background: #f1f5f9;
            color: #64748b;
        }

        /* Bet Table Styles */
        .bet-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .bet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .bet-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bet-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .bet-table tbody tr:hover {
            background: #f8fafc;
        }

        .bet-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bet-status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .bet-status-confirmed {
            background: #dbeafe;
            color: #1e40af;
        }

        .bet-status-won {
            background: #dcfce7;
            color: #166534;
        }

        .bet-status-lost {
            background: #fee2e2;
            color: #dc2626;
        }

        .bet-status-paid {
            background: #f0fdf4;
            color: #059669;
        }

        .bet-amount {
            font-weight: 600;
            color: #059669;
            font-family: 'DM Sans', monospace;
        }

        .bet-payout {
            font-weight: 600;
            color: #7c3aed;
            font-family: 'DM Sans', monospace;
        }

        .bet-profit {
            font-weight: 600;
            font-family: 'DM Sans', monospace;
        }

        .bet-profit.positive {
            color: #059669;
        }

        .bet-profit.negative {
            color: #dc2626;
        }

        .bet-profit.neutral {
            color: #64748b;
        }

        .bet-actions {
            display: flex;
            gap: 4px;
        }

        .bet-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bet-action-btn.view {
            background: #dbeafe;
            color: #1e40af;
        }

        .bet-action-btn.edit {
            background: #fef3c7;
            color: #92400e;
        }

        .bet-action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .bet-action-btn:hover {
            transform: scale(1.05);
        }

        /* Bet Filters */
        .bet-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .bet-filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            color: #374151;
            min-width: 120px;
        }

        .bet-search-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 200px;
        }

        .bet-search-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .bet-control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bet-control-btn.primary {
            background: #059669;
            color: white;
        }

        .bet-control-btn.secondary {
            background: #f1f5f9;
            color: #374151;
        }

        .bet-control-btn.danger {
            background: #dc2626;
            color: white;
        }

        .bet-control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Bet Chart */
        .bet-chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .bet-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .bet-chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .bet-chart-legend {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
        }

        .bet-chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bet-chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .bet-chart-canvas {
            width: 100%;
            height: 200px;
            background: #f8fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
                min-height: auto;
            }
            
            .dashboard-tabs {
                width: 100%;
                justify-content: center;
                order: 1;
            }
            
            .user-info-section {
                min-width: auto;
                width: 100%;
                justify-content: center;
                order: 2;
            }
            
            .dashboard-controls {
                width: 100%;
                justify-content: center;
                order: 3;
            }
            
            .compact-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bet-table {
                font-size: 0.75rem;
            }
            
            .bet-table th,
            .bet-table td {
                padding: 8px 12px;
            }
            
            .bet-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* FAQ Page Styles */
        .faq-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        .faq-header h2 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #232526;
            margin-bottom: 12px;
        }

        .faq-subtitle {
            font-size: 1.1rem;
            color: #6b7280;
            margin: 0;
        }

        .faq-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .faq-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .faq-section h3 {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px 24px;
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .faq-item {
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s ease;
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-item:hover {
            background-color: #f8fafc;
        }

        .faq-item h4 {
            padding: 20px 24px;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #232526;
            cursor: pointer;
            transition: color 0.2s ease;
            position: relative;
        }

        .faq-item h4:hover {
            color: #2563eb;
        }

        .faq-item h4::after {
            content: '';
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #6b7280;
            transition: transform 0.2s ease;
        }

        .faq-item.active h4::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .faq-content {
            padding: 0 24px 20px 24px;
            color: #374151;
            line-height: 1.6;
            display: none;
        }

        .faq-content p {
            margin-bottom: 16px;
        }

        .faq-content ul, .faq-content ol {
            margin-bottom: 16px;
            padding-left: 20px;
        }

        .faq-content li {
            margin-bottom: 8px;
        }

        .faq-content strong {
            color: #232526;
            font-weight: 600;
        }

        /* FAQ Mobile Styles */
        @media (max-width: 768px) {
            .faq-header h2 {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .faq-subtitle {
                font-size: 1rem;
            }
            
            .faq-container {
                padding: 0 16px;
            }
            
            .faq-section {
                margin-bottom: 24px;
            }
            
            .faq-section h3 {
                padding: 16px 20px;
                font-size: 1.2rem;
            }
            
            .faq-item h4 {
                padding: 16px 20px;
                font-size: 1rem;
                min-height: 48px;
                display: flex;
                align-items: center;
            }
            
            .faq-content {
                padding: 0 20px 16px 20px;
                font-size: 0.9rem;
            }
            
            .faq-content ul, .faq-content ol {
                padding-left: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="center-box" id="mainBox">
        <div class="login-header">
            <div class="title-container">
                <h1 class="main-title">
                    <span class="title-word ranked">RANKED</span>
                    <span class="title-word war">WAR</span>
                    <span class="title-word bookie">BOOKIE</span>
                </h1>
                <div class="beta-badge">BETA V1</div>
            </div>
        </div>
        

        
        <div class="login-form">
            <div class="api-input">
                <input type="text" id="apiKey" placeholder="Enter Public Torn API KEY" minlength="16" maxlength="64">
                <button id="connectBtn" onclick="connectAPI()">Connect</button>
            </div>
            <div class="error-message" id="errorMsg"></div>
            <div class="success-message" id="successMsg"></div>
        </div>
    </div>
    <div id="dashboard" class="dashboard" style="display:none;">
        <div class="dashboard-header">
            <!-- Navigation Tabs (Left) -->
            <div class="dashboard-tabs">
                <button class="dashboard-tab active" data-tab="colosseum">Colosseum</button>
            </div>
            
            <!-- User Info Section (Right) -->
            <div class="user-info-section" id="user-info-section" style="display: none;">
                <div class="user-avatar" id="user-avatar">
                    
                </div>
                <div class="user-details">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-level" id="user-level">Level: --</div>
                    <div class="user-faction" id="user-faction">Faction: --</div>
                </div>
            </div>
            
            <!-- Controls (Right) -->
            <div class="dashboard-controls">
                <button class="logout-btn" onclick="logout()"> Logout</button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="tab-content" id="tab-colosseum">
                <div class="betting-info">
                    <p> <strong>How Betting Works:</strong> Factions are chosen randomly for betting. Place bets by sending Xanax to the bookie. To avoid mugging, bets are made via Xanax - each Xanax represents $744,983. Copy the bet message and include it in the item transfer message when sending the Xanax. Payouts will be made in cash, not Xanax.</p>
                </div>
                    
                <div id="betting-loading" class="inventory-loading">Loading Ranked Wars...</div>
                <div id="betting-content" style="display:none;">
                    <div id="betting-stats" class="betting-stats"></div>
                    <div class="search-container" style="margin-bottom: 20px;">
                        <input type="text" id="faction-search" placeholder="Search faction..." class="faction-search-input">
                    </div>
                    <div id="betting-grid" class="betting-grid"></div>
                    
                    <!-- Last Updated Footer -->
                    <div style="text-align: center; margin-top: 30px; padding: 20px; color: #6b7280; font-size: 0.9rem; border-top: 1px solid #e5e7eb;">
                        <span id="betting-last-updated"></span>
                    </div>
                </div>
                    </div>
                    
            <!-- Betting Modal -->
            <div id="betting-modal" class="betting-modal">
                <div class="betting-modal-content">
                    <div class="betting-modal-header">
                        <div class="betting-modal-title">Place Your Bet</div>
                        <button class="betting-modal-close" onclick="closeBettingModal()">&times;</button>
                                </div>
                    <div id="betting-modal-body">
                        <!-- Modal content will be populated dynamically -->
                            </div>
                        </div>
                        </div>





        </div>
    </div>

    <script>
        let apiKey = '';
        let userData = null;

        let autoRefreshInterval = null;
        
        let isAutoRefreshEnabled = false;
        
        // Betting system variables
        let bettingData = null;
        let bettingCache = null;
        let autoRefreshBettingInterval = null;
        let isAutoRefreshBettingEnabled = false;
        let selectedBet = null;
        const XANAX_PRICE =744983; // $700,000 per Xanax
        const MAX_XANAX_PER_PLAYER = 5; // Maximum Xanax any player can bet - EASY TO CHANGE
        
        // API-based odds system (disabled - no external connections)
        let oddsAPI = {
            baseURL: null,
            calculateOdds: null,
            healthCheck: null
        };
        let historicalData = {}; // Historical faction performance data
        let currentBettingVolume = {}; // Current betting volume data
        
        // Filter system
        let currentFilter = 'all';
        let currentSearch = '';
        




        function connectAPI() {
            const apiKeyInput = document.getElementById('apiKey');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            
            apiKey = apiKeyInput.value.trim();
            
            // Save API key to localStorage
            if (apiKey) {
                localStorage.setItem('tornApiKey', apiKey);
            }
            
            if (!apiKey) {
                errorMsg.textContent = 'Please enter your API key';
                return;
            }
            
            if (apiKey.length < 16) {
                errorMsg.textContent = 'API key must be at least 16 characters';
                return;
            }
            
            errorMsg.textContent = '';
            successMsg.textContent = 'Connecting...';
            
            // Test the API key by fetching user data from Torn API
            fetch(`https://api.torn.com/user/?selections=profile&key=${apiKey}&comment=TryItPage`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error.error || 'Invalid API key');
                    }
                    
                    userData = {
                        playerId: data.player_id,
                        name: data.name
                    };
                    
                    successMsg.innerHTML = `Connected successfully!<br><span style="color: #2563eb; font-weight: 600;">Welcome ${data.name} (${data.player_id})</span>`;
                    
                    // Update user info section
                    updateUserInfo(userData);
                    
                    // Show dashboard after a short delay
                    setTimeout(() => {
                        document.getElementById('mainBox').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'flex';
                        
                        // Automatically load betting interface since Colosseum tab is active by default
                        loadBettingInterface();
                        
                        // Load user's existing bets
                        loadUserBets();
                        
                        // Enable automatic refresh for betting data
                        startAutoRefreshBetting();
                        
                        // Enable automatic refresh for user bets
                        startAutoRefreshUserBets();
                    }, 1000);
                })
                .catch(error => {
                    console.error('API verification error:', error);
                    errorMsg.textContent = `Error: ${error.message}`;
                    successMsg.textContent = '';
                });
        }

        // Check for existing API key on page load
        function checkExistingApiKey() {
            const savedApiKey = localStorage.getItem('tornApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                apiKey = savedApiKey;
                // Auto-connect if API key exists
                connectAPI();
            }
        }

        // Logout function
        function logout() {
            // Clear API key from localStorage
            localStorage.removeItem('tornApiKey');
            
            // Reset variables
            apiKey = null;
            userData = null;
            
            // Hide user info section
            const userInfoSection = document.getElementById('user-info-section');
            if (userInfoSection) {
                userInfoSection.style.display = 'none';
            }
            
            // Show login screen
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('mainBox').style.display = 'flex';
            
            // Clear API key input
            document.getElementById('apiKey').value = '';
            
            // Clear messages
            document.getElementById('errorMsg').textContent = '';
            document.getElementById('successMsg').textContent = '';
            
            console.log('Logged out successfully');
        }

        // Update user info section with player data
        function updateUserInfo(playerData) {
            const userInfoSection = document.getElementById('user-info-section');
            const userName = document.getElementById('user-name');
            const userLevel = document.getElementById('user-level');
            const userFaction = document.getElementById('user-faction');
            const userAvatar = document.getElementById('user-avatar');
            
            if (playerData && playerData.name) {
                // Show the user info section
                userInfoSection.style.display = 'flex';
                
                // Update user name with player ID
                const playerId = playerData.player_id || playerData.playerId || '--';
                userName.textContent = `${playerData.name} (${playerId})`;
                
                // Update user level
                userLevel.textContent = `Level: ${playerData.level || '--'}`;
                
                // Update user faction
                userFaction.textContent = `Faction: ${playerData.faction || 'None'}`;
                
                // Update avatar with first letter of name
                const firstLetter = playerData.name.charAt(0).toUpperCase();
                userAvatar.textContent = firstLetter;
                
                console.log(' User info updated:', playerData.name, 'ID:', playerId);
            } else {
                // Hide the user info section if no data
                userInfoSection.style.display = 'none';
                console.log('  No user data available');
            }
        }

        // Handle Enter key in API key input
        document.getElementById('apiKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connectAPI();
            }
        });
        


        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // Add active class to clicked tab and show corresponding content
                    this.classList.add('active');
                    document.getElementById(`tab-${targetTab}`).style.display = 'block';
                    
                    // Load data when switching to tabs
                    if (targetTab === 'colosseum' && apiKey) {
                        loadBettingInterface();
                    }
                });
            });
            
            // Filter tab functionality (simplified - only 'all' filter)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-tab')) {
                    const filterTabs = document.querySelectorAll('.filter-tab');
                    filterTabs.forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    currentFilter = 'all'; // Always show all wars
                    displayFilteredBettingCards();
                }
            });
            
            // Search functionality
            const searchInput = document.getElementById('faction-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    currentSearch = e.target.value;
                    displayFilteredBettingCards();
                });
            }
        });











        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            
            const date = new Date(parseInt(timestamp));
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            return date.toLocaleString(undefined, options);
        }

        function updateLastUpdated() {
            const lastUpdatedEl = document.getElementById('last-updated');
            const now = new Date();
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString(undefined, options)}`;
        }

        function toggleAutoRefresh() {
            const toggleBtn = document.getElementById('auto-refresh-toggle');
            
            if (isAutoRefreshEnabled) {
                // Disable auto refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                isAutoRefreshEnabled = false;
                toggleBtn.textContent = ' Auto Refresh';
            } else {
                // Enable auto refresh
    
                isAutoRefreshEnabled = true;
                toggleBtn.textContent = ' Auto Refresh';
            }
        }

        // Betting Cache System
        class BettingCache {
            constructor() {
                this.cacheKey = 'tornBettingData';
                this.cacheDuration = 5 * 60 * 1000; // 5 minutes
            }

            save(data) {
                const cacheData = {
                    data: data,
                    timestamp: Date.now(),
                    version: '1.0'
                };
                
                try {
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    console.log('Betting data cached successfully');
                } catch (error) {
                    console.error('Error saving betting cache:', error);
                }
            }

            load() {
                try {
                    const stored = localStorage.getItem(this.cacheKey);
                    if (!stored) return null;

                    const parsed = JSON.parse(stored);
                    const age = Date.now() - parsed.timestamp;

                    if (age < this.cacheDuration) {
                        console.log('Using cached betting data');
                        return parsed.data;
                    } else {
                        console.log('Cached betting data expired, fetching fresh data');
                        return null;
                    }
            } catch (error) {
                    console.error('Error loading cached betting data:', error);
                    return null;
                }
            }

            clear() {
                localStorage.removeItem(this.cacheKey);
            }

            isValid() {
                const stored = localStorage.getItem(this.cacheKey);
                if (!stored) return false;

                try {
                    const parsed = JSON.parse(stored);
                    const age = Date.now() - parsed.timestamp;
                    return age < this.cacheDuration;
                } catch {
                    return false;
                }
            }
        }

        // Initialize betting cache
        bettingCache = new BettingCache();
        
        // Initialize API-based odds calculation
        initializeOddsAPI();
        
        // Initialize sample historical data
        // Sample data initialization removed - using real data only
        
        // Helper function to format odds display
        function formatOddsDisplay(odds) {
            if (typeof odds === 'number' && odds >= 1) {
                // Decimal odds format
                return odds.toFixed(2);
            } else if (typeof odds === 'string' && (odds.startsWith('+') || odds.startsWith('-'))) {
                // American odds format (legacy)
                return odds;
            } else if (typeof odds === 'number') {
                // Percentage format (legacy)
                return `${odds}%`;
            } else {
                // Fallback to reasonable decimal odds
                return '2.00';
            }
        }

        // Helper function to calculate returns for decimal odds
        function calculateReturns(odds, xanaxAmount = 1) {
            if (typeof odds === 'number' && odds >= 1) {
                // Decimal odds calculation - FIXED: Don't round Xanax amount, round final dollar amount
                return Math.round(xanaxAmount * odds * XANAX_PRICE);
            } else if (typeof odds === 'string' && (odds.startsWith('+') || odds.startsWith('-'))) {
                // American odds calculation (legacy)
                const oddsValue = parseInt(odds.replace('+', ''));
                const betValue = xanaxAmount * XANAX_PRICE;
                
                if (oddsValue > 0) {
                    // Positive odds: win $odds for every $100 bet
                    return Math.round(betValue + (betValue * (oddsValue / 100)));
                } else {
                    // Negative odds: bet $|odds| to win $100
                    return Math.round(betValue + (betValue * (100 / Math.abs(oddsValue))));
                }
            } else if (typeof odds === 'number') {
                // Legacy percentage calculation
                return Math.round(XANAX_PRICE * (100 / odds));
            } else {
                // Fallback
                return XANAX_PRICE * 2;
            }
        }

        // Initialize API-based odds calculation
        function initializeOddsAPI() {
            // Calculate odds between two factions using the API
            oddsAPI.calculateOdds = async function(faction1Id, faction2Id) {
                // Odds calculation disabled - no external connections
                console.log(' Odds calculation disabled - no external connections');
                // Return fallback odds
                return {
                    [faction1Id]: {
                        odds: 2.00,
                        impliedProbability: 0.50,
                        trueProbability: 0.485,
                        format: 'decimal',
                        bettingExamples: [
                            { bet: 1, totalReturn: 2, profit: 1, description: 'Bet 1 Xanax  Win 2 Xanax total (1 profit)' }
                        ]
                    },
                    [faction2Id]: {
                        odds: 2.00,
                        impliedProbability: 0.50,
                        trueProbability: 0.515,
                        format: 'decimal',
                        bettingExamples: [
                            { bet: 1, totalReturn: 2, profit: 1, description: 'Bet 1 Xanax  Win 2 Xanax total (1 profit)' }
                        ]
                    },
                    metadata: {
                        confidence: 0,
                        timestamp: new Date(),
                        fallback: true
                    }
                };
            };
            
            // Health check for the odds engine
            oddsAPI.healthCheck = async function() {
                console.log(' Health check disabled - no external connections');
                return null;
            };
            
            console.log('Odds API initialized');
        }
        
        // Sample data functions removed - using real data only

        // Betting System Functions
        async function loadBettingInterface() {
            const loadingEl = document.getElementById('betting-loading');
            const contentEl = document.getElementById('betting-content');
            
            // Try to load from cache first
            const cachedData = bettingCache.load();
            if (cachedData) {
                bettingData = cachedData;
                displayBettingInterface();
                updateBettingLastUpdated();
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            }
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';

            try {
                // Load data from GitHub repository
                console.log('Loading betting data from GitHub repository...');
                // Add cache-busting parameter to ensure fresh data
            const cacheBuster = '?v=' + Date.now();
            const response = await fetch('https://raw.githubusercontent.com/Lofi-Sol/BDash/main/Data/random_wars_sample.json' + cacheBuster);
                if (!response.ok) {
                    throw new Error(`Failed to load JSON data from GitHub: ${response.status}`);
                }
                
                const jsonData = await response.json();
                console.log(' Loaded JSON data:', jsonData);
                console.log(' Wars in JSON data:', jsonData.data.map(war => war['War ID']));
                
                // Transform JSON data into betting format
                bettingData = transformJsonDataToBetting(jsonData);
                
                console.log(`Loaded ${bettingData.length} wars for betting from JSON file`);
                
                // Cache the data
                bettingCache.save(bettingData);
                
                displayBettingInterface();
                updateBettingLastUpdated();
                
            } catch (error) {
                console.error('Error loading betting data:', error);
                loadingEl.textContent = `Error: ${error.message}`;
                
                // If fetch failed but we have cached data, show it
                if (cachedData) {
                    bettingData = cachedData;
                    displayBettingInterface();
                    updateBettingLastUpdated();
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                }
            }
        }

        function transformJsonDataToBetting(jsonData) {
            const bettingMarkets = [];
            
            if (!jsonData.data || !Array.isArray(jsonData.data)) {
                console.error('Invalid JSON data structure');
                return [];
            }
            
            jsonData.data.forEach(war => {
                // Determine status based on the war data
                // For demo purposes, make most wars "upcoming" to show the countdown timer
                let status = 'upcoming'; // Default to upcoming
                if (war.Status === 'Active' && Math.random() < 0.3) { // Only 30% of active wars show as active
                    status = 'active';
                } else if (war.Status === 'Finished' && Math.random() < 0.2) { // Only 20% of finished wars show as finished
                    status = 'finished';
                }
                
                // Calculate countdown time using actual start dates from JSON
                let countdownTime = null;
                if (status === 'upcoming' && war['Start Date'] && war['Start Time']) {
                    try {
                        // Parse the actual start date and time from JSON
                        const startDateStr = war['Start Date']; // Format: "2025-09-19"
                        const startTimeStr = war['Start Time']; // Format: "13:00"
                        
                        // Create a proper Date object from the JSON data
                        const startDateTime = new Date(startDateStr + 'T' + startTimeStr + ':00');
                        countdownTime = startDateTime.getTime();
                        
                        console.log('War ' + war['War ID'] + ' start time: ' + startDateTime.toLocaleString());
                    } catch (error) {
                        console.error('Error parsing start time for war ' + war['War ID'] + ':', error);
                        // Fallback to current time + 1 hour if parsing fails
                        countdownTime = Date.now() + (60 * 60 * 1000);
                    }
                } else if (!countdownTime) {
                    // Fallback for wars without specific start times
                    countdownTime = Date.now() + (60 * 60 * 1000); // 1 hour from now
                }
                
                bettingMarkets.push({
                    id: war['War ID'],
                    title: `War #${war['War ID']}`,
                    subtitle: `Lead Target: ${war['Target Score'].toLocaleString()}`,
                    status: status,
                    startTime: countdownTime,
                    endTime: 0,
                    target: war['Target Score'],
                    winner: war['Winner Faction ID'] || 0,
                    countdownTime: countdownTime,
                    options: [
                        {
                            id: war['Faction 1 ID'],
                            name: war['Faction 1 Name'],
                            score: war['Faction 1 Score'],
                            chain: war['Faction 1 Chain'],
                            respect: war['Faction 1 Respect Value'],
                            rank: war['Faction 1 Rank Value'],
                            members: war['Faction 1 Members'],
                            position: null, // Not available in JSON
                            odds: war['Faction 1 Odds'] || 2.00, // Use calculated odds
                            confidence: war['Faction 1 Confidence'] || 'N/A',
                            impliedPercent: war['Faction 1 Implied %'] || 'N/A',
                            truePercent: war['Faction 1 True %'] || 'N/A',
                            betExample: war['Faction 1 Bet Example'] || 'N/A',
                            volume: 0,
                            warsWon: war['Faction 1 Wars Won'],
                            warsLost: war['Faction 1 Wars Lost'],
                            winRate: war['Faction 1 Win Rate']
                        },
                        {
                            id: war['Faction 2 ID'],
                            name: war['Faction 2 Name'],
                            score: war['Faction 2 Score'],
                            chain: war['Faction 2 Chain'],
                            respect: war['Faction 2 Respect Value'],
                            rank: war['Faction 2 Rank Value'],
                            members: war['Faction 2 Members'],
                            position: null, // Not available in JSON
                            odds: war['Faction 2 Odds'] || 2.00, // Use calculated odds
                            confidence: war['Faction 2 Confidence'] || 'N/A',
                            impliedPercent: war['Faction 2 Implied %'] || 'N/A',
                            truePercent: war['Faction 2 True %'] || 'N/A',
                            betExample: war['Faction 2 Bet Example'] || 'N/A',
                            volume: 0,
                            warsWon: war['Faction 2 Wars Won'],
                            warsLost: war['Faction 2 Wars Lost'],
                            winRate: war['Faction 2 Win Rate']
                        }
                    ],
                    totalVolume: 0
                });
            });
            
            console.log(`Transformed ${bettingMarkets.length} wars from JSON data`);
            return bettingMarkets;
        }

        async function fetchFactionChainData(warData, apiKey) {
            const factionEnhancedData = {};
            const uniqueFactionIds = new Set();
            
            // Collect all unique faction IDs from wars
            Object.values(warData || {}).forEach(war => {
                Object.keys(war.factions).forEach(factionId => {
                    uniqueFactionIds.add(factionId);
                });
            });
            
            // Load local faction data
            let localFactionData = {};
            try {
                console.log('Loading local faction data...');
                console.log(' Local faction data loading disabled - no external connections');
                const localResult = { factions: [] };
                
                if (localResult.factions) {
                    // Convert array to object for easier lookup
                    localFactionData = localResult.factions.reduce((acc, faction) => {
                        acc[faction.id] = faction;
                        return acc;
                    }, {});
                    console.log(`Loaded ${Object.keys(localFactionData).length} factions from local data`);
                } else {
                    console.warn('Failed to load local faction data');
                }
            } catch (error) {
                console.warn('Error loading local faction data:', error);
            }
            
            // Use only local faction data to avoid rate limiting
            Array.from(uniqueFactionIds).forEach((factionId) => {
                const localData = localFactionData[factionId] || {};
                factionEnhancedData[factionId] = {
                    chain: localData.chain || 0,
                    respect: localData.respect || null,
                    rank: localData.rank || null,
                    members: localData.members || null,
                    position: localData.position || null
                };
            });
            
            console.log('Fetched enhanced faction data:', factionEnhancedData);
            console.log('Total factions with enhanced data:', Object.keys(factionEnhancedData).length);
            console.log('Sample enhanced data:', Object.entries(factionEnhancedData).slice(0, 3));
            
            // Log factions with respect data
            const factionsWithRespect = Object.entries(factionEnhancedData)
                .filter(([id, data]) => data.respect !== null)
                .length;
            console.log(`Factions with respect data: ${factionsWithRespect}/${Object.keys(factionEnhancedData).length}`);
            
            return factionEnhancedData;
        }

        async function transformWarDataToBetting(warData, factionEnhancedData = {}) {
            const bettingMarkets = [];
            
            // Load real faction data for names
            let realFactionData = {};
            try {
                console.log(' Faction data loading disabled - no external connections');
                const factionResult = { factions: [] };
                if (factionResult.factions) {
                    realFactionData = factionResult.factions.reduce((acc, faction) => {
                        acc[faction.id] = faction;
                        return acc;
                    }, {});
                    console.log(` Loaded ${Object.keys(realFactionData).length} real factions for names`);
                    console.log(' Sample faction data:', Object.entries(realFactionData).slice(0, 3));
                }
            } catch (error) {
                console.warn(' Error loading real faction data:', error);
            }
            
            // Process only real war data - no sample data
            for (const [warId, war] of Object.entries(warData || {})) {
                const factionIds = Object.keys(war.factions);
                const faction1 = war.factions[factionIds[0]];
                const faction2 = war.factions[factionIds[1]];
                
                console.log(`\n Processing War ${warId}:`);
                console.log(`   Faction IDs: ${factionIds[0]} vs ${factionIds[1]}`);
                console.log(`   Faction IDs type check: ${typeof factionIds[0]} vs ${typeof factionIds[1]}`);
                
                // Get enhanced faction data (chain, respect, rank, etc.)
                const faction1Enhanced = factionEnhancedData[factionIds[0]] || { chain: 0, respect: null, rank: null, members: null, position: null };
                const faction2Enhanced = factionEnhancedData[factionIds[1]] || { chain: 0, respect: null, rank: null, members: null, position: null };
                
                // Get real faction names from factions.json
                // Convert faction IDs to numbers for proper lookup
                const faction1IdNum = parseInt(factionIds[0]);
                const faction2IdNum = parseInt(factionIds[1]);
                const realFaction1 = realFactionData[faction1IdNum] || {};
                const realFaction2 = realFactionData[faction2IdNum] || {};
                
                console.log(`   Real faction 1 lookup: ID ${factionIds[0]} -> ${realFaction1.name || 'NOT FOUND'}`);
                console.log(`   Real faction 2 lookup: ID ${factionIds[1]} -> ${realFaction2.name || 'NOT FOUND'}`);
                
                // Log enhanced data usage for debugging
                console.log(`   Enhanced data 1: Chain: ${faction1Enhanced.chain}, Respect: ${faction1Enhanced.respect?.toLocaleString() || 'N/A'}, Rank: ${faction1Enhanced.rank || 'N/A'}, Members: ${faction1Enhanced.members || 'N/A'}`);
                console.log(`   Enhanced data 2: Chain: ${faction2Enhanced.chain}, Respect: ${faction2Enhanced.respect?.toLocaleString() || 'N/A'}, Rank: ${faction2Enhanced.rank || 'N/A'}, Members: ${faction2Enhanced.members || 'N/A'}`);
                
                // Create war data with enhanced faction information
                const warDataWithEnhancedInfo = {
                    id: warId,
                    factions: {
                        [factionIds[0]]: { ...faction1, ...faction1Enhanced },
                        [factionIds[1]]: { ...faction2, ...faction2Enhanced }
                    },
                    war: war.war
                };
                
                // Calculate odds using the new API-based system
                console.log(`    Calculating odds for factions ${factionIds[0]} vs ${factionIds[1]}...`);
                const calculatedOdds = await oddsAPI.calculateOdds(factionIds[0], factionIds[1]);
                const odds1 = calculatedOdds[factionIds[0]]?.odds || 2.00;
                const odds2 = calculatedOdds[factionIds[1]]?.odds || 2.00;
                
                console.log(`    Calculated odds: Faction ${factionIds[0]} = ${odds1}, Faction ${factionIds[1]} = ${odds2}`);
                console.log(`    Full odds response:`, calculatedOdds);
                
                // Determine actual status based on current time and war state
                const now = Math.floor(Date.now() / 1000);
                let actualStatus;
                if (war.war.winner !== 0) {
                    actualStatus = 'finished';
                } else if (war.war.start > now) {
                    actualStatus = 'preparing';
                } else {
                    actualStatus = 'active';
                }
                
                bettingMarkets.push({
                    id: warId,
                    title: `War #${warId}`,
                    subtitle: `Lead Target: ${war.war.target.toLocaleString()}`,
                    status: actualStatus,
                    startTime: war.war.start,
                    endTime: war.war.end || 0,
                    target: war.war.target,
                    winner: war.war.winner,
                    options: [
                        {
                            id: factionIds[0],
                            name: realFaction1.name || `Faction ${factionIds[0]}`,
                            score: faction1.score,
                            chain: faction1Enhanced.chain,
                            respect: faction1Enhanced.respect,
                            rank: faction1Enhanced.rank,
                            members: faction1Enhanced.members,
                            position: faction1Enhanced.position,
                            odds: odds1,
                            volume: 0
                        },
                        {
                            id: factionIds[1],
                            name: realFaction2.name || `Faction ${factionIds[1]}`,
                            score: faction2.score,
                            chain: faction2Enhanced.chain,
                            respect: faction2Enhanced.respect,
                            rank: faction2Enhanced.rank,
                            members: faction2Enhanced.members,
                            position: faction2Enhanced.position,
                            odds: odds2,
                            volume: 0
                        }
                    ],
                    totalVolume: 0
                });
            }

            console.log(`Processed ${bettingMarkets.length} real wars for betting`);
            return bettingMarkets;
        }

        function displayBettingInterface() {
            const loadingEl = document.getElementById('betting-loading');
            const contentEl = document.getElementById('betting-content');
            const statsEl = document.getElementById('betting-stats');
            const gridEl = document.getElementById('betting-grid');

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            if (!bettingData || bettingData.length === 0) {
                gridEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No Ranked Wars available</div>';
                return;
            }

            // Display statistics
            displayBettingStats();

            // Display betting cards with current filter
            displayFilteredBettingCards();
        }
        
        function displayFilteredBettingCards() {
            const gridEl = document.getElementById('betting-grid');
            
            if (!bettingData) return;
            
            let filteredData = bettingData;
            
            // Apply current filter (simplified - show all wars)
            // No filtering needed since we only show all wars
            
            // Apply search filter
            if (currentSearch.trim() !== '') {
                const searchTerm = currentSearch.toLowerCase().trim();
                filteredData = filteredData.filter(market => {
                    return market.options.some(option => 
                        option.name.toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            if (filteredData.length === 0) {
                let message = 'No Ranked Wars available';
                if (currentSearch.trim() !== '') {
                    message = `No Ranked Wars found for "${currentSearch}"`;
                }
                gridEl.innerHTML = `<div style="text-align: center; padding: 40px; color: #6b7280;">${message}</div>`;
                return;
            }
            
            gridEl.innerHTML = filteredData.map(market => createBettingCard(market)).join('');
        }

        function displayBettingStats() {
            const statsEl = document.getElementById('betting-stats');
            
            if (!bettingData) return;

            const stats = {
                total: bettingData.length,
                active: bettingData.filter(market => market.status === 'active').length,
                finished: bettingData.filter(market => market.status === 'finished').length
            };

            statsEl.innerHTML = `
                <div class="betting-stat-card">
                    <h3>Total Wars</h3>
                    <div class="value">${stats.total}</div>
                </div>
                <div class="betting-stat-card">
                    <h3>Active Wars</h3>
                    <div class="value">${stats.active}</div>
                </div>
                <div class="betting-stat-card">
                    <h3>Finished Wars</h3>
                    <div class="value">${stats.finished}</div>
                </div>
            `;
        }

        // Format start date and time
        function formatStartDateTime(startTime) {
            if (!startTime) {
                // If no start time is available, show a placeholder
                return ' Start time TBD';
            }
            
            // startTime is already in milliseconds (JavaScript timestamp)
            const date = new Date(startTime);
            
            // Check if the date is valid
            if (isNaN(date.getTime())) {
                return ' Start time TBD';
            }
            
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short',
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone // Use visitor's local timezone
            };
            
            return date.toLocaleDateString('en-US', options);
        }

        function createBettingCard(market) {
            // Format start date and time
            const startDateTime = formatStartDateTime(market.startTime);
            
            return `
                <div class="betting-card" data-market-id="${market.id}">
                    <div class="betting-card-header">
                        <div class="war-id">${market.title}</div>
                        <div class="lead-target">Lead Target: ${market.target.toLocaleString()}</div>
                        <div class="start-datetime">${startDateTime}</div>
                    </div>
                    
                    <div class="betting-card-content">
                        <div class="faction-section">
                            ${market.options.map(option => `
                                <div class="faction-row">
                                    <div class="faction-info">
                                        <div class="faction-name">
                                            <a href="https://www.torn.com/factions.php?step=profile&ID=${option.id}" target="_blank" style="color: inherit; text-decoration: none;">
                                                ${option.name}
                                            </a>
                                        </div>
                                    </div>
                                    <div class="faction-odds">
                                        <div class="odds-value">${option.odds.toFixed(2)}</div>
                                        <div class="odds-money">$${calculateReturns(option.odds, 1).toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="betting-card-footer">
                        <div class="betting-info">
                            <span class="money-bag"></span>
                            <span class="no-bets">No bets placed</span>
                        </div>
                        <button class="place-bet-btn" onclick="placeBet('${market.id}')">Place Bet</button>
                    </div>
                </div>
            `;
        }

        function getBettingStatus(status) {
            switch (status) {
                case 'active':
                    return { text: 'Active', class: 'active' };
                case 'finished':
                    return { text: 'Finished', class: 'finished' };
                case 'upcoming':
                    return { text: 'Upcoming', class: 'upcoming' };
                default:
                    return { text: 'Upcoming', class: 'upcoming' };
            }
        }

        function generateCountdownTimer(market) {
            if (market.status !== 'upcoming' || !market.countdownTime) {
                return '';
            }
            
            const now = Date.now();
            const timeDiff = market.countdownTime - now;
            
            if (timeDiff <= 0) {
                return '';
            }
            
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            return `
                <div class="countdown-timer">
                    <span class="timer-icon"></span>
                    <span class="timer-text">${hours}h ${minutes}m ${seconds}s</span>
                </div>
            `;
        }

        function generateTimerHtml(market) {
            const now = Math.floor(Date.now() / 1000);
            const startTime = market.startTime;
            const endTime = market.endTime || 0;
            
            // Determine actual status based on current time
            let actualStatus = market.status;
            if (market.status === 'preparing' && startTime <= now) {
                actualStatus = 'active';
            }
            
            if (actualStatus === 'finished') {
                const duration = endTime > startTime ? endTime - startTime : 0;
                return `
                    <div class="betting-timer finished">
                        <span class="betting-timer-icon"></span>
                        <span>${formatDuration(duration)}</span>
                    </div>
                `;
            } else if (actualStatus === 'active') {
                const duration = now - startTime;
                return `
                    <div class="betting-timer duration" data-start-time="${startTime}">
                        <span class="betting-timer-icon"></span>
                        <span class="timer-text">${formatDuration(duration)}</span>
                    </div>
                `;
            } else {
                // Preparing - countdown to start
                const timeUntilStart = startTime - now;
                if (timeUntilStart > 0) {
                    return `
                        <div class="betting-timer countdown" data-start-time="${startTime}">
                            <span class="betting-timer-icon"></span>
                            <span class="timer-text">${formatCountdown(timeUntilStart)}</span>
                        </div>
                    `;
                } else {
                    // Should be active but marked as preparing
                    const duration = Math.abs(now - startTime);
                    return `
                        <div class="betting-timer duration" data-start-time="${startTime}">
                            <span class="betting-timer-icon"></span>
                            <span class="timer-text">${formatDuration(duration)}</span>
                        </div>
                    `;
                }
            }
        }

        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            } else if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return `${hours}h ${minutes}m ${remainingSeconds}s`;
            } else {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${days}d ${hours}h ${minutes}m`;
            }
        }

        function formatCountdown(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            } else if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return `${hours}h ${minutes}m ${remainingSeconds}s`;
                    } else {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${days}d ${hours}h ${minutes}m`;
            }
        }

        function selectBettingOption(marketId, optionId) {
            // Remove previous selections
            document.querySelectorAll('.betting-option.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked option
            const optionEl = document.querySelector(`[onclick="selectBettingOption('${marketId}', '${optionId}')"]`);
            if (optionEl) {
                optionEl.classList.add('selected');
            }
        }

        function placeBet(marketId) {
            console.log(' placeBet called with marketId:', marketId, 'type:', typeof marketId);
            console.log(' bettingData:', bettingData);
            
            if (!bettingData) {
                console.error(' bettingData is null or undefined');
                alert('Betting data not loaded yet. Please wait and try again.');
                return;
            }
            
            // Debug: Show all market IDs in bettingData
            console.log(' All market IDs in bettingData:', bettingData.map(m => ({ id: m.id, type: typeof m.id, title: m.title })));
            
            // Try to find market with flexible ID matching (handles both string and number)
            let market = bettingData.find(m => m.id == marketId); // Use loose equality for type conversion
            
            if (!market) {
                // Fallback: try explicit type conversion
                market = bettingData.find(m => String(m.id) === String(marketId));
            }
            
            console.log(' Found market:', market);
            
            if (!market) {
                console.error(' Market not found for ID:', marketId);
                console.error(' Available market IDs:', bettingData.map(m => m.id));
                alert('Market not found. Please refresh the page and try again.');
                return;
            }
            
            const canBet = canPlaceBet(market);
            console.log(' Can place bet:', canBet);
            
            if (!canBet) {
                console.log(' Cannot place bet - market conditions not met');
                alert('Betting is not available for this war at this time.');
                return;
            }

            selectedBet = { marketId, market };
            console.log(' Opening betting modal...');
            openBettingModal();
        }

        function openBettingModal() {
            console.log(' openBettingModal called');
            const modal = document.getElementById('betting-modal');
            const modalBody = document.getElementById('betting-modal-body');
            
            console.log(' Modal element:', modal);
            console.log(' Modal body element:', modalBody);
            console.log(' selectedBet:', selectedBet);
            
            if (!modal) {
                console.error(' Modal element not found!');
                alert('Modal element not found. Please refresh the page.');
                return;
            }
            
            if (!modalBody) {
                console.error(' Modal body element not found!');
                alert('Modal body element not found. Please refresh the page.');
                return;
            }
            
            if (!selectedBet) {
                console.error(' No selected bet!');
                return;
            }

            const { market, marketId } = selectedBet;
            
            console.log('\n BETTING MODAL DEBUG:');
            console.log('   Market ID:', marketId);
            console.log('   Market options:', market.options.map(opt => `${opt.id}: ${opt.name} (odds: ${opt.odds})`));
            console.log('   XANAX_PRICE:', XANAX_PRICE);
            console.log('   Market options detailed:', market.options.map(opt => ({
                id: opt.id,
                name: opt.name,
                odds: opt.odds,
                oddsType: typeof opt.odds
            })));
            
            modalBody.innerHTML = `
                <div class="betting-message">
                    Bet range: 1-${MAX_XANAX_PER_PLAYER} Xanax ($${XANAX_PRICE.toLocaleString()} - $${(XANAX_PRICE * MAX_XANAX_PER_PLAYER).toLocaleString()})
                    ${market.status === 'preparing' ? '<br> This war starts soon - bet will be active when war begins!' : ''}
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Select Faction:</label>
                    <select id="betting-faction-select" class="betting-form-input" onchange="console.log(' Faction selection changed to:', this.value); updateBettingCalculations();">
                        ${market.options.map(option => `
                            <option value="${option.id}">${option.name} (${formatOddsDisplay(option.odds)})</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Xanax Amount:</label>
                    <input type="number" id="betting-xanax-amount" class="betting-form-input" 
                           min="1" max="${MAX_XANAX_PER_PLAYER}" step="1" value="1" placeholder="Enter Xanax amount (max ${MAX_XANAX_PER_PLAYER})">
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">
                        Maximum bet: ${MAX_XANAX_PER_PLAYER} Xanax
                    </div>
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Value:</label>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; font-weight: 600;">
                        $<span id="betting-value-display">${XANAX_PRICE.toLocaleString()}</span>
                        </div>
                        </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Potential Return:</label>
                    <div style="padding: 12px; background: #f0fdf4; border-radius: 6px; font-weight: 600; color: #059669;">
                        $<span id="betting-return-display">${XANAX_PRICE.toLocaleString()}</span>
                        </div>
                    </div>
                
                <div class="betting-form-actions">
                    <button class="betting-form-btn betting-form-btn-secondary" onclick="closeBettingModal()">Cancel</button>
                    <button class="betting-form-btn betting-form-btn-primary" onclick="placeBetNow()">Place Bet</button>
                </div>
                `;
            
            console.log(' Setting modal display to flex...');
            modal.style.display = 'flex';
            console.log(' Modal display set. Modal visible:', modal.style.display);
            
            // Add event listeners for real-time calculations (remove existing first to prevent duplicates)
            const xanaxInput = document.getElementById('betting-xanax-amount');
            const factionSelect = document.getElementById('betting-faction-select');
            
            // Remove existing event listeners
            xanaxInput.removeEventListener('input', updateBettingCalculations);
            factionSelect.removeEventListener('change', updateBettingCalculations);
            
            // Add fresh event listeners
            xanaxInput.addEventListener('input', updateBettingCalculations);
            factionSelect.addEventListener('change', updateBettingCalculations);
            
            console.log(' Event listeners added for real-time calculations');
            
            // Initialize calculations
            updateBettingCalculations();
        }

        function updateBettingCalculations() {
            const xanaxInput = document.getElementById('betting-xanax-amount');
            const xanaxAmount = parseInt(xanaxInput.value) || 1;
            const factionId = document.getElementById('betting-faction-select').value;
            
            console.log(' updateBettingCalculations called');
            console.log('   Input value:', xanaxInput.value);
            console.log('   Parsed amount:', xanaxAmount);
            console.log('   Faction ID:', factionId);
            
            // Validate Xanax amount
            if (xanaxAmount < 1 || xanaxAmount > MAX_XANAX_PER_PLAYER) {
                console.warn(' Invalid Xanax amount:', xanaxAmount, '(valid range: 1-', MAX_XANAX_PER_PLAYER, ')');
                return;
            }
            
            // Use flexible ID matching to handle string/number type differences
            let faction = selectedBet.market.options.find(opt => opt.id == factionId); // Loose equality
            
            if (!faction) {
                // Fallback: try explicit type conversion
                faction = selectedBet.market.options.find(opt => String(opt.id) === String(factionId));
            }
            
            console.log('\n BETTING CALCULATION DEBUG:');
            console.log('   Selected faction ID:', factionId, '(type:', typeof factionId, ')');
            console.log('   Available factions:', selectedBet.market.options.map(opt => `${opt.id} (${typeof opt.id}): ${opt.name} (${opt.odds})`));
            console.log('    Faction lookup result:', faction ? 'FOUND' : 'NOT FOUND');
            console.log('    SelectedBet market ID:', selectedBet.marketId);
            console.log('    SelectedBet market options count:', selectedBet.market.options.length);
            
            if (!faction) {
                console.error(' Faction not found for ID:', factionId);
                return;
            }
            
            console.log('    Found faction:', faction.name);
            console.log('    Faction data:', faction);
            console.log('    Odds value:', faction.odds, '(type:', typeof faction.odds, ')');
            
            const betValue = xanaxAmount * XANAX_PRICE;
            console.log('    Bet value calculation:', xanaxAmount, 'x', XANAX_PRICE, '=', betValue);
            
            // Calculate total return using decimal odds
            let totalReturn;
            if (typeof faction.odds === 'number' && faction.odds >= 1) {
                // Decimal odds calculation - Total return includes original stake + winnings
                const rawReturn = xanaxAmount * faction.odds * XANAX_PRICE;
                totalReturn = Math.round(rawReturn);
                console.log('    Decimal odds calculation:');
                console.log('      Raw calculation:', xanaxAmount, 'x', faction.odds, 'x', XANAX_PRICE, '= $', rawReturn);
                console.log('      Rounded return: $', totalReturn);
                console.log('      This includes original bet + winnings');
            } else if (typeof faction.odds === 'string' && (faction.odds.startsWith('+') || faction.odds.startsWith('-'))) {
                // American odds calculation (legacy)
                const oddsValue = parseInt(faction.odds.replace('+', ''));
                console.log('    American odds calculation (legacy):', faction.odds);
                
                if (oddsValue > 0) {
                    // Positive odds: win $odds for every $100 bet
                    totalReturn = Math.round(betValue + (betValue * (oddsValue / 100)));
                } else {
                    // Negative odds: bet $|odds| to win $100
                    totalReturn = Math.round(betValue + (betValue * (100 / Math.abs(oddsValue))));
                }
            } else if (typeof faction.odds === 'number') {
                // Legacy percentage calculation
                totalReturn = Math.round(betValue * (100 / faction.odds));
                console.log('    Legacy percentage calculation:', faction.odds);
            } else {
                // Fallback
                totalReturn = betValue * 2;
                console.log('    Fallback calculation (2x)');
            }
            
            document.getElementById('betting-value-display').textContent = betValue.toLocaleString();
            document.getElementById('betting-return-display').textContent = totalReturn.toLocaleString();
            
            console.log('    Final result:');
            console.log('      Bet Value: $', betValue.toLocaleString());
            console.log('      Total Return: $', totalReturn.toLocaleString());
            console.log('      Profit: $', (totalReturn - betValue).toLocaleString());
            console.log('      Profit Percentage: %', (((totalReturn - betValue) / betValue) * 100).toFixed(2));
            
            // Verify calculation step by step
            console.log('    Calculation verification:');
            console.log('      Xanax Amount:', xanaxAmount);
            console.log('      Odds:', faction.odds);
            console.log('      XANAX_PRICE:', XANAX_PRICE);
            console.log('      Step 1 (xanax * odds):', xanaxAmount * faction.odds);
            console.log('      Step 2 (result * price):', (xanaxAmount * faction.odds * XANAX_PRICE));
            console.log('      Step 3 (rounded):', Math.round(xanaxAmount * faction.odds * XANAX_PRICE));
        }

        function placeBetNow() {
            const xanaxAmount = parseInt(document.getElementById('betting-xanax-amount').value) || 1;
            const factionId = document.getElementById('betting-faction-select').value;
            
            // Use flexible ID matching to handle string/number type differences
            let faction = selectedBet.market.options.find(opt => opt.id == factionId); // Loose equality
            
            if (!faction) {
                // Fallback: try explicit type conversion
                faction = selectedBet.market.options.find(opt => String(opt.id) === String(factionId));
            }
            
            if (!faction || xanaxAmount < 1) {
                alert('Please enter a valid Xanax amount (minimum 1)');
                return;
            }
            
            // Check betting limit
            if (xanaxAmount > MAX_XANAX_PER_PLAYER) {
                alert(`Betting limit exceeded. Maximum allowed: ${MAX_XANAX_PER_PLAYER} Xanax, attempted: ${xanaxAmount} Xanax`);
                return;
            }
            
            // Save bet to localStorage for tracking immediately
            const betResult = saveBetToTracking(selectedBet.marketId, factionId, xanaxAmount, faction.name);
            
            if (!betResult) {
                alert('Error saving bet. Please try again.');
                return;
            }
            
            // Show success message and bet details
            const betMessage = `BET:${selectedBet.marketId}:${factionId}:${xanaxAmount}:${betResult.betId}`;
            
            const modalBody = document.getElementById('betting-modal-body');
            modalBody.innerHTML = `
                <div class="betting-message" style="background: #dcfce7; border-color: #bbf7d0; color: #166534;">
                     Bet placed successfully! Your bet has been recorded and is now pending confirmation.
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Details:</label>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; line-height: 1.5;">
                        <strong>War:</strong> ${selectedBet.market.title}<br>
                        <strong>Faction:</strong> ${faction.name}<br>
                                                        <strong>Xanax Amount:</strong> ${xanaxAmount}<br>
                        <strong>Bet Value:</strong> $${(xanaxAmount * XANAX_PRICE).toLocaleString()}<br>
                        <strong>Status:</strong> <span style="color: #f59e0b; font-weight: 600;">Pending</span>
                        </div>
                    </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Message (for Torn City):</label>
                    <div style="position: relative;">
                        <textarea id="betting-message-text" class="betting-form-input" rows="3" readonly>${betMessage}</textarea>
                        <button class="betting-copy-btn" onclick="copyBetMessage()" style="position: absolute; top: 8px; right: 8px;">
                             Copy
                        </button>
                        </div>
                            </div>
                
                                        <div class="betting-form-group">
                            <label class="betting-form-label">Bookie:</label>
                            <div style="position: relative;">
                                <input type="text" value="VanillaScoop [3520571]" readonly class="betting-form-input" style="background: #f8fafc;">
                                <button class="betting-copy-btn" onclick="copyBookieName()" style="position: absolute; top: 8px; right: 8px;">
                                    Copy
                                </button>
                            </div>
                        </div>

                        <div class="betting-form-group">
                            <label class="betting-form-label">Next Steps:</label>
                            <div style="padding: 12px; background: #f0fdf4; border-radius: 6px; font-size: 0.9rem; line-height: 1.5;">
                                1. Copy the bet message above<br>
                                2. Go to Torn City and send ${xanaxAmount} Xanax to VanillaScoop [3520571]<br>
                                3. Paste the bet message in the item transfer message<br>
                                4. Your bet will be confirmed when the transfer is processed<br>
                                5. Your bet will be processed and confirmed automatically
                            </div>
                        </div>
                
                <div class="betting-form-actions">
                    <button class="betting-form-btn betting-form-btn-primary" onclick="closeBettingModal()">Close</button>
                    </div>
                `;

            // Show success notification
            showBetPlacedNotification(xanaxAmount, faction.name, selectedBet.market.title);
        }
        
        function generateBetMessage() {
            const xanaxAmount = parseInt(document.getElementById('betting-xanax-amount').value) || 1;
            const factionId = document.getElementById('betting-faction-select').value;
            
            // Use flexible ID matching to handle string/number type differences
            let faction = selectedBet.market.options.find(opt => opt.id == factionId); // Loose equality
            
            if (!faction) {
                // Fallback: try explicit type conversion
                faction = selectedBet.market.options.find(opt => String(opt.id) === String(factionId));
            }
            
            if (!faction || xanaxAmount < 1) {
                alert('Please enter a valid Xanax amount (minimum 1)');
                return;
            }
            
            // Check betting limit
            if (xanaxAmount > MAX_XANAX_PER_PLAYER) {
                alert(`Betting limit exceeded. Maximum allowed: ${MAX_XANAX_PER_PLAYER} Xanax, attempted: ${xanaxAmount} Xanax`);
                return;
            }
            
            const betMessage = `BET:${selectedBet.marketId}:${factionId}:${xanaxAmount}`;
            
            const modalBody = document.getElementById('betting-modal-body');
            modalBody.innerHTML = `
                <div class="betting-message">
                     Bet message generated! Copy the message below and paste it when sending Xanax in Torn City.
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Message:</label>
                    <div style="position: relative;">
                        <textarea id="betting-message-text" class="betting-form-input" rows="3" readonly>${betMessage}</textarea>
                        <button class="betting-copy-btn" onclick="copyBetMessage()" style="position: absolute; top: 8px; right: 8px;">
                             Copy
                        </button>
                        </div>
                    </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Instructions:</label>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; line-height: 1.5;">
                        1. Copy the bet message above<br>
                        2. Go to Torn City and send ${xanaxAmount} Xanax to the bookie<br>
                        3. Paste the bet message in the item transfer message<br>
                        4. Your bet will be confirmed when the transfer is processed
                        </div>
                        </div>
                
                <div class="betting-form-actions">
                    <button class="betting-form-btn betting-form-btn-secondary" onclick="closeBettingModal()">Close</button>
                    </div>
                `;
        }
        
        // Generate unique bet ID
        function generateBetId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Check if bet ID already exists
        function isBetIdUnique(betId) {
            const existingBets = localStorage.getItem('tornBets');
            if (!existingBets) return true;
            
            try {
                const bets = JSON.parse(existingBets);
                return !bets.some(bet => bet.betId === betId);
            } catch (error) {
                console.error('Error checking bet ID uniqueness:', error);
                return true;
            }
        }
        
        // Save bet to tracking system
        function saveBetToTracking(warId, factionId, xanaxAmount, factionName) {
            // Get existing bets from localStorage
            const existingBets = localStorage.getItem('tornBets');
            let bets = [];
            
            if (existingBets) {
                try {
                    bets = JSON.parse(existingBets);
                } catch (error) {
                    console.error('Error parsing existing bets:', error);
                    bets = [];
                }
            }
            
            // Generate unique bet ID
            let betId;
            do {
                betId = generateBetId();
            } while (!isBetIdUnique(betId));
            
            console.log(' Generated bet ID:', betId);
            
            // Get the actual odds from the selected faction
            let odds = 2.0; // Default fallback
            if (selectedBet && selectedBet.market && selectedBet.market.options) {
                const faction = selectedBet.market.options.find(opt => opt.id == factionId);
                if (faction) {
                    odds = faction.odds || 2.0;
                }
            }
            
            // Create new bet entry
            const newBet = {
                id: Date.now(), // Internal tracking ID
                betId: betId, // Unique bet ID for message
                playerId: userData?.playerId || 'Unknown', // Use actual player ID if available
                warId: warId,
                factionId: factionId,
                factionName: factionName,
                xanaxAmount: xanaxAmount,
                betAmount: xanaxAmount * XANAX_PRICE,
                odds: odds, // Include the actual odds
                timestamp: Date.now(),
                status: 'pending'
            };
            
            // Add to beginning of array (most recent first)
            bets.unshift(newBet);
            
            // Save back to localStorage
            try {
                localStorage.setItem('tornBets', JSON.stringify(bets));
                console.log('Bet saved to tracking:', newBet);
            } catch (error) {
                console.error('Error saving bet to tracking:', error);
                return null;
            }
            
            // Also save to server API
            saveBetToServer(newBet);
            
            return { id: newBet.id, betId: newBet.betId }; // Return both IDs
        }
        
        // Save bet to Google Sheets
        async function saveBetToServer(betData) {
            try {
                // Use odds from bet data (already calculated correctly)
                const odds = betData.odds || 2.0;
                
                console.log(' Saving bet to Google Sheets with odds:', odds, 'for faction:', betData.factionName);
                console.log(' User data available:', userData);
                console.log(' Player name being sent:', userData?.name || 'Unknown');
                
                // Prepare data for Google Sheets
                const betMessage = `BET:${betData.warId}:${betData.factionId}:${betData.xanaxAmount}:${betData.betId}`;
                const requestBody = {
                    playerId: betData.playerId,
                    warId: betData.warId,
                    factionId: betData.factionId,
                    factionName: betData.factionName,
                    xanaxAmount: betData.xanaxAmount,
                    betAmount: betData.betAmount,
                    betId: betData.betId, // Include the bet ID
                    betMessage: betMessage, // Include the bet message
                    playerName: userData?.name || 'Unknown', // Include the real player name
                    odds: odds,
                    timestamp: betData.timestamp
                };
                
                console.log(' Request body being sent to Google Sheets:', requestBody);
                
                // Send to Google Sheets
                const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbw67cnqqFbKBdWUSPHHe6mYMfurP7GO0kemhFPzi-lhOtAFMoEGGOF5Ropcv_XAG1I-HA/exec';
                
                if (GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    console.log(' Google Sheets URL not configured - bet saved to localStorage only');
                    console.log(' Bet would have been saved to Google Sheets:', requestBody);
                    console.log(' To enable Google Sheets integration:');
                    console.log('   1. Set up Google Apps Script (see BETTING_SHEETS_SETUP.md)');
                    console.log('   2. Deploy as web app and get the URL');
                    console.log('   3. Replace YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE with your URL');
                    return;
                }
                
                // Try JSONP approach to bypass CORS
                try {
                    // Create a unique callback function name
                    const callbackName = 'bettingCallback_' + Date.now();
                    
                    // Create the callback function
                    window[callbackName] = function(result) {
                        console.log(' Bet saved to Google Sheets (JSONP):', result);
                        if (result.success) {
                            showNotification(' Bet sent to bookie', 'success');
                        }
                        // Clean up
                        delete window[callbackName];
                        if (script) script.remove();
                    };
                    
                    // Build JSONP URL
                    const jsonpUrl = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&data=' + encodeURIComponent(JSON.stringify(requestBody));
                    
                    // Create script element for JSONP
                    const script = document.createElement('script');
                    script.src = jsonpUrl;
                    script.onerror = function() {
                        console.error(' JSONP request failed');
                        showNotification(' Bet saved locally (bookie unavailable)', 'warning');
                        delete window[callbackName];
                        script.remove();
                    };
                    
                    // Add script to page
                    document.head.appendChild(script);
                    
                    // Fallback timeout
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.error(' JSONP request timed out');
                            showNotification(' Bet saved locally (bookie timeout)', 'warning');
                            delete window[callbackName];
                            if (script.parentNode) script.remove();
                        }
                    }, 10000);
                    
                } catch (jsonpError) {
                    console.error(' JSONP error:', jsonpError);
                    showNotification(' Bet saved locally (bookie error)', 'warning');
                }
                
            } catch (error) {
                console.error(' Error saving bet to Google Sheets:', error);
                // Fallback: bet is already saved to localStorage
            }
        }
        
        // Show general notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#059669' : type === 'warning' ? '#f59e0b' : '#3b82f6';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-size: 0.9rem;
                font-weight: 500;
                max-width: 300px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Show bet placed notification
        function showBetPlacedNotification(xanaxAmount, factionName, warTitle) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 1.1rem;">
                     Bet Placed Successfully!
                                </div>
                <div style="font-size: 0.9rem; line-height: 1.4;">
                    <strong>${xanaxAmount}</strong> on <strong>${factionName}</strong><br>
                    <span style="opacity: 0.9;">${warTitle}</span><br>
                    <span style="color: #fbbf24; font-weight: 600;">Status: Pending</span>
                                </div>
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
            
            // Add slideOut animation
            const slideOutStyle = document.createElement('style');
            slideOutStyle.textContent = `
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(slideOutStyle);
        }

        // Consolidated copy bet message function that handles both cases
        function copyBetMessage(betId) {
            let message;
            
            if (betId) {
                // Case 1: Copy message for a specific bet (from user bets or bet table)
                const bet = userBetsData?.find(b => b.betId === betId) || allBets?.find(b => b.betId === betId);
                if (!bet) {
                    console.error('Bet not found for ID:', betId);
                    return;
                }
                message = generateBetMessageFromData(bet);
                
                // Use modern clipboard API with fallback
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(message).then(() => {
                        showUserNotification('Bet Message Copied', 'Bet message has been copied to clipboard!');
                    }).catch(err => {
                        console.error('Failed to copy bet message:', err);
                        // Fallback: show the message in an alert
                        alert(`Bet Message:\n${message}\n\nCopy this message manually.`);
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = message;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showUserNotification('Bet Message Copied', 'Bet message has been copied to clipboard!');
                }
            } else {
                // Case 2: Copy message from betting form textarea
                const messageText = document.getElementById('betting-message-text');
                if (!messageText) {
                    console.error('Betting message textarea not found');
                    return;
                }
                
                messageText.select();
                document.execCommand('copy');
                
                const copyBtn = document.querySelector('.betting-copy-btn');
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = ' Copied!';
                    copyBtn.style.background = '#059669';
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '#3b82f6';
                    }, 2000);
                }
            }
        }

        function copyBookieName() {
            const bookieInput = document.querySelector('input[value="VanillaScoop [3520571]"]');
            if (bookieInput) {
                bookieInput.select();
                document.execCommand('copy');
                
                const copyBtn = document.querySelector('button[onclick="copyBookieName()"]');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = ' Copied!';
                copyBtn.style.background = '#059669';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#3b82f6';
                }, 2000);
            }
        }

        function closeBettingModal() {
            const modal = document.getElementById('betting-modal');
            modal.style.display = 'none';
            selectedBet = null;
        }

        function updateBettingLastUpdated() {
            const lastUpdatedEl = document.getElementById('betting-last-updated');
            const now = new Date();
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString(undefined, options)}`;
        }

        // Start automatic refresh for betting
        function startAutoRefreshBetting() {
            if (autoRefreshBettingInterval) {
                clearInterval(autoRefreshBettingInterval);
            }
            autoRefreshBettingInterval = setInterval(loadBettingInterface, 300000); // Refresh every 5 minutes
            isAutoRefreshBettingEnabled = true;
        }
        
        // Stop automatic refresh for betting
        function stopAutoRefreshBetting() {
            if (autoRefreshBettingInterval) {
                clearInterval(autoRefreshBettingInterval);
                autoRefreshBettingInterval = null;
            }
            isAutoRefreshBettingEnabled = false;
        }

        // Timer update functionality
        function updateTimers() {
            const now = Math.floor(Date.now() / 1000);
            
            // Update countdown timers
            document.querySelectorAll('.betting-timer.countdown[data-start-time]').forEach(timer => {
                const startTime = parseInt(timer.getAttribute('data-start-time'));
                const timeUntilStart = startTime - now;
                
                if (timeUntilStart > 0) {
                    const timerText = timer.querySelector('.timer-text');
                    if (timerText) {
                        timerText.textContent = formatCountdown(timeUntilStart);
                    }
                        } else {
                    // War has started, update to duration
                    timer.className = 'betting-timer duration';
                    timer.setAttribute('data-start-time', startTime);
                    timer.innerHTML = `
                        <span class="betting-timer-icon"></span>
                        <span class="timer-text">${formatDuration(0)}</span>
                    `;
                }
            });
            
            // Update duration timers
            document.querySelectorAll('.betting-timer.duration[data-start-time]').forEach(timer => {
                const startTime = parseInt(timer.getAttribute('data-start-time'));
                const duration = Math.abs(now - startTime);
                const timerText = timer.querySelector('.timer-text');
                if (timerText) {
                    timerText.textContent = formatDuration(duration);
                }
            });
            
            // Update any timers that might have wrong status
            document.querySelectorAll('.betting-timer').forEach(timer => {
                const startTime = parseInt(timer.getAttribute('data-start-time'));
                if (startTime) {
                    const timeUntilStart = startTime - now;
                    const currentClass = timer.className;
                    
                    if (timeUntilStart > 0 && !currentClass.includes('countdown')) {
                        // Should be countdown
                        timer.className = 'betting-timer countdown';
                        timer.innerHTML = `
                            <span class="betting-timer-icon"></span>
                            <span class="timer-text">${formatCountdown(timeUntilStart)}</span>
                        `;
                    } else if (timeUntilStart <= 0 && !currentClass.includes('duration')) {
                        // Should be duration
                        timer.className = 'betting-timer duration';
                        const duration = Math.abs(now - startTime);
                        timer.innerHTML = `
                            <span class="betting-timer-icon"></span>
                            <span class="timer-text">${formatDuration(duration)}</span>
                        `;
                    }
                }
            });
        }

        // Start timer updates
        setInterval(updateTimers, 1000); // Update every second
        
        // Start odds updates
        // setInterval(updateOdds, 15000); // DISABLED - preserves JSON calculated odds
        
        // Update odds in real-time
        async function updateOdds() {
            // DISABLED - preserves JSON calculated odds from Google Apps Script
            if (!bettingData || !oddsAPI.calculateOdds) return;
            
            // Update odds for all Ranked Wars
            for (const market of bettingData) {
                if (market.options.length === 2) {
                    try {
                        const faction1Id = market.options[0].id;
                        const faction2Id = market.options[1].id;
                        
                        // Calculate new odds using API
                        const newOdds = await oddsAPI.calculateOdds(faction1Id, faction2Id);
                        
                        // Update market odds - handle new sportsbook format
                        if (newOdds[faction1Id] && typeof newOdds[faction1Id] === 'object') {
                            // New sportsbook format
                            market.options[0].odds = newOdds[faction1Id].odds;
                            market.options[0].impliedProbability = newOdds[faction1Id].impliedProbability;
                            market.options[0].trueProbability = newOdds[faction1Id].trueProbability;
                        } else {
                            // Fallback to reasonable decimal odds instead of percentage
                            market.options[0].odds = newOdds[faction1Id] || 2.00;
                        }
                        
                        if (newOdds[faction2Id] && typeof newOdds[faction2Id] === 'object') {
                            // New decimal format
                            market.options[1].odds = newOdds[faction2Id].odds;
                            market.options[1].impliedProbability = newOdds[faction2Id].impliedProbability;
                            market.options[1].trueProbability = newOdds[faction2Id].trueProbability;
                        } else {
                            // Fallback to reasonable decimal odds instead of percentage
                            market.options[1].odds = newOdds[faction2Id] || 2.00;
                        }
                        
                    } catch (error) {
                        console.error(`Failed to update odds for market ${market.id}:`, error);
                        // Keep existing odds on error
                    }
                }
            }
            
            // Refresh display if betting interface is active
            if (document.getElementById('betting-content').style.display !== 'none') {
                displayBettingInterface();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('betting-modal');
            if (event.target === modal) {
                closeBettingModal();
            }
        });
        
        

        

        

        

        
        function showBetConfirmedNotification(xanaxAmount, factionName, warId) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                padding: 16px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 1.1rem;">
                     Bet Confirmed!
                </div>
                <div style="font-size: 0.9rem; line-height: 1.4;">
                    <strong>${xanaxAmount}</strong> on <strong>${factionName}</strong><br>
                    <span style="opacity: 0.9;">War #${warId}</span><br>
                    <span style="color: #10b981; font-weight: 600;">Status: Confirmed</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        


        // Check if betting is allowed for a war
        function canPlaceBet(market) {
            console.log(' canPlaceBet check for market:', market.id, 'status:', market.status);
            
            const now = Math.floor(Date.now() / 1000);
            const warStartTime = market.startTime / 1000; // Convert from milliseconds to seconds
            const fiveDaysInSeconds = 5 * 24 * 60 * 60; // 5 days in seconds
            
            console.log(' Current time:', now, 'War start time:', warStartTime);
            console.log(' Time until start:', warStartTime - now, 'seconds');
            
            // Allow betting if:
            // 1. War is active (has started but not finished)
            // 2. War is upcoming/preparing but within 5 days of starting
            if (market.status === 'active') {
                console.log(' Betting allowed - war is active');
                return true;
            } else if (market.status === 'upcoming' || market.status === 'preparing') {
                const timeUntilStart = warStartTime - now;
                const canBet = timeUntilStart <= fiveDaysInSeconds && timeUntilStart > 0;
                console.log(' Betting allowed for upcoming war:', canBet);
                return canBet;
            }
            
            console.log(' Betting not allowed - status:', market.status);
            return false;
        }
        
        


        // User Bet Tracking System
        let userBetsData = [];
        let autoRefreshUserBetsInterval = null;
        let isAutoRefreshUserBetsEnabled = false;

        // Load user's bets
        async function loadUserBets() {
            console.log(' Loading user bets...');
            console.log(' User data:', userData);
            console.log(' API key available:', !!apiKey);
            
            // Use existing bet tracking HTML structure
            const betTableBody = document.getElementById('bet-table-body');
            if (!betTableBody) {
                console.error(' Bet table body not found');
                return;
            }

            try {
                // Check if user is authenticated
                if (!userData || !userData.playerId || !apiKey) {
                    console.log('User not authenticated, using localStorage fallback');
                    // Fallback to localStorage for non-authenticated users
                    const existingBets = localStorage.getItem('tornBets');
                    if (!existingBets) {
                        userBetsData = [];
                        displayUserBets();
                        return;
                    }

                    const allBets = JSON.parse(existingBets);
                    const currentPlayerId = userData?.playerId || 'Unknown';
                    userBetsData = allBets.filter(bet => 
                        bet.playerId.toString() === currentPlayerId.toString()
                    );
                } else {
                    // Server API disabled - use localStorage fallback
                    console.log(' Server API disabled - using localStorage fallback for player:', userData.playerId);
                    const existingBets = localStorage.getItem('tornBets');
                    if (existingBets) {
                        const allBets = JSON.parse(existingBets);
                        const currentPlayerId = userData?.playerId || 'Unknown';
                        userBetsData = allBets.filter(bet => 
                            bet.playerId.toString() === currentPlayerId.toString()
                        );
                        console.log('Loaded bets from localStorage:', userBetsData.length);
                    } else {
                        userBetsData = [];
                        console.log('No bets found in localStorage');
                    }
                }

                // Refresh live war data before displaying
                await refreshLiveWarData();

                // Update the existing bet tracking display
                updateUserBetsDisplay();
                updateBetStats();
                updateBetTable();
                updateBetFilters();
                
            } catch (error) {
                console.error('Error loading user bets:', error);
                console.error('Error details:', error);
            }
        }

        // Update user bets display using existing bet tracking structure
        function updateUserBetsDisplay() {
            console.log(' Updating user bets display...');
            console.log(' Total bets loaded:', allBets ? allBets.length : 0);
            
            if (allBets && allBets.length > 0) {
                console.log(' User bets loaded successfully');
                console.log(' Sample bet:', allBets[0]);
            } else {
                console.log('  No user bets found');
            }
        }

        // Display user's bets
        function displayUserBets() {
            const loadingEl = document.getElementById('user-bets-loading');
            const contentEl = document.getElementById('user-bets-content');
            const statsEl = document.getElementById('user-bets-stats');
            const containerEl = document.getElementById('user-bets-container');

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            if (!userBetsData || userBetsData.length === 0) {
                containerEl.innerHTML = `
                    <div class="no-bets-message">
                        <h3>No bets placed yet</h3>
                        <p>Start betting on faction wars to see your activity here!</p>
                        <button class="btn btn-primary" onclick="switchToColosseum()">Go to Colosseum</button>
                    </div>
                `;
                return;
            }

            // Display statistics
            displayUserBetsStats();

            // Display bet cards
            containerEl.innerHTML = userBetsData.map(bet => createUserBetCard(bet)).join('');
        }

        // Display user betting statistics
        function displayUserBetsStats() {
            const statsEl = document.getElementById('user-bets-stats');
            
            if (!userBetsData) return;

            const stats = {
                total: userBetsData.length,
                pending: userBetsData.filter(bet => bet.status === 'pending').length,
                confirmed: userBetsData.filter(bet => bet.status === 'confirmed').length,
                won: userBetsData.filter(bet => bet.status === 'won').length,
                lost: userBetsData.filter(bet => bet.status === 'lost').length,
                totalValue: userBetsData.reduce((sum, bet) => sum + bet.betAmount, 0),
                totalPayouts: userBetsData
                    .filter(bet => bet.status === 'won')
                    .reduce((sum, bet) => sum + (bet.payoutAmount || 0), 0)
            };

            statsEl.innerHTML = `
                <div class="user-bet-stat-card">
                    <h3>Total Bets</h3>
                    <div class="value">${stats.total}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Total Value</h3>
                    <div class="value">$${(stats.totalValue / 1000000).toFixed(1)}M</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Pending</h3>
                    <div class="value">${stats.pending}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Confirmed</h3>
                    <div class="value">${stats.confirmed}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Won</h3>
                    <div class="value">${stats.won}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Lost</h3>
                    <div class="value">${stats.lost}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Total Payouts</h3>
                    <div class="value">$${(stats.totalPayouts / 1000000).toFixed(1)}M</div>
                </div>
            `;
        }

        // Create user bet card
        function createUserBetCard(bet) {
            const status = getUserBetStatus(bet.status);
            const timePlaced = formatTimestamp(bet.timestamp);
            const payoutAmount = calculatePayoutAmount(bet);
            const payoutStatus = getPayoutStatus(bet);
            const expectedWinPayout = calculateExpectedWinPayout(bet);
            const expectedLossAmount = calculateExpectedLossAmount(bet);
            
            // Get live war data for this bet
            const warData = getLiveWarData(bet.warId);
            const warStatus = getWarStatus(warData);
            const liveScores = getLiveScores(warData, bet.factionId);
            
            return `
                <div class="user-bet-card">
                    <div class="user-bet-header">
                        <div class="user-bet-title">Bet ${bet.betId}</div>
                        <span class="user-bet-status ${status.class}">${status.text}</span>
                    </div>
                    
                    <div class="user-bet-content">
                        <div class="user-bet-details">
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">War</div>
                                <div class="user-bet-detail-value">
                                    <a href="https://www.torn.com/war.php?step=rankreport&rankID=${bet.warId}" target="_blank">
                                        War #${bet.warId}
                                    </a>
                                </div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Faction</div>
                                <div class="user-bet-detail-value">
                                    <a href="https://www.torn.com/factions.php?step=profile&ID=${bet.factionId}" target="_blank">
                                        ${bet.factionName}
                                    </a>
                                </div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Xanax Amount</div>
                                <div class="user-bet-detail-value">${bet.xanaxAmount}</div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Bet Value</div>
                                <div class="user-bet-detail-value">$${(bet.betAmount / 1000000).toFixed(1)}M</div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Expected Win</div>
                                <div class="user-bet-detail-value" style="color: #059669;">$${(expectedWinPayout / 1000000).toFixed(1)}M</div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Expected Loss</div>
                                <div class="user-bet-detail-value" style="color: #dc2626;">-$${(expectedLossAmount / 1000000).toFixed(1)}M</div>
                            </div>
                        </div>
                        
                        <!-- Live War Status -->
                        <div class="user-bet-war-status">
                            <div class="user-bet-war-status-header">
                                <span class="user-bet-war-status-icon"></span>
                                <span class="user-bet-war-status-text">${warStatus}</span>
                            </div>
                            ${liveScores}
                        </div>
                        
                        ${bet.status === 'won' ? `
                            <div class="user-bet-payout">
                                <div class="user-bet-payout-title"> Congratulations! You Won!</div>
                                <div class="user-bet-payout-amount">$${(payoutAmount / 1000000).toFixed(1)}M</div>
                                <div class="user-bet-payout-status ${payoutStatus.class}">${payoutStatus.text}</div>
                            </div>
                        ` : ''}
                        
                        ${bet.status === 'lost' ? `
                            <div class="user-bet-payout" style="background: #fef2f2; border-color: #fecaca;">
                                <div class="user-bet-payout-title" style="color: #dc2626;"> Better luck next time!</div>
                                <div class="user-bet-payout-amount" style="color: #dc2626;">Lost ${bet.xanaxAmount}</div>
                            </div>
                        ` : ''}
                        
                        ${bet.status === 'pending' ? `
                            <div class="user-bet-message">
                                <strong>Bet Message:</strong><br>
                                ${generateBetMessageFromData(bet)}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="user-bet-actions">
                        <div class="user-bet-time">Placed: ${timePlaced}</div>
                        <div class="user-bet-buttons">
                            ${bet.status === 'pending' ? `
                                <button class="user-bet-btn user-bet-btn-secondary" onclick="copyBetMessage('${bet.betId}')"> Copy Message</button>
                            ` : ''}
                            
                            ${bet.status === 'won' && payoutStatus.text === 'Pending' ? `
                                <button class="user-bet-btn user-bet-btn-primary" onclick="requestPayout('${bet.betId}')"> Request Payout</button>
                            ` : ''}
                            
                            ${bet.status === 'confirmed' ? `
                                <button class="user-bet-btn user-bet-btn-secondary" disabled> Waiting for War End</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get user bet status
        function getUserBetStatus(status) {
            switch (status) {
                case 'pending':
                    return { text: 'Pending', class: 'pending' };
                case 'confirmed':
                    return { text: 'Confirmed', class: 'confirmed' };
                case 'won':
                    return { text: 'Won', class: 'won' };
                case 'lost':
                    return { text: 'Lost', class: 'lost' };
                case 'paid':
                    return { text: 'Paid', class: 'paid' };
                default:
                    return { text: 'Unknown', class: 'pending' };
            }
        }

        // Calculate expected win payout (based on odds)
        function calculateExpectedWinPayout(bet) {
            // Use the actual odds from the bet
            const odds = bet.odds || 2.00;
            // For decimal odds: payout = bet amount * odds
            return Math.round(bet.betAmount * odds);
        }

        // Calculate expected loss amount (what they lose if they lose)
        function calculateExpectedLossAmount(bet) {
            // This is simply the bet amount they placed
            return bet.betAmount;
        }

        // Calculate payout amount (for won bets)
        function calculatePayoutAmount(bet) {
            if (bet.status !== 'won') return 0;
            
            // Use the same calculation as expected win payout
            return calculateExpectedWinPayout(bet);
        }

        // Get payout status
        function getPayoutStatus(bet) {
            if (bet.status !== 'won') {
                return { text: 'N/A', class: '' };
            }
            
            if (bet.payoutStatus === 'paid') {
                return { text: ' Paid', class: 'paid' };
            } else {
                return { text: ' Pending', class: 'pending' };
            }
        }

        // Generate bet message for existing bet data
        function generateBetMessageFromData(bet) {
            return `BET:${bet.warId}:${bet.factionId}:${bet.xanaxAmount}:${bet.betId}`;
        }


        // Request payout (placeholder function)
        function requestPayout(betId) {
            showUserNotification('Payout Requested', 'Your payout request has been submitted. You will be contacted soon!');
        }

        // Switch to Colosseum tab
        function switchToColosseum() {
            const colosseumTab = document.querySelector('[data-tab="colosseum"]');
            if (colosseumTab) {
                colosseumTab.click();
            }
        }

        // Update user bets last updated timestamp
        function updateUserBetsLastUpdated() {
            const lastUpdatedEl = document.getElementById('user-bets-last-updated');
            const now = new Date();
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString(undefined, options)}`;
        }

        // Start automatic refresh for user bets
        function startAutoRefreshUserBets() {
            if (autoRefreshUserBetsInterval) {
                clearInterval(autoRefreshUserBetsInterval);
            }
            autoRefreshUserBetsInterval = setInterval(async () => {
                await refreshLiveWarData();
                displayUserBets(); // Re-render with updated data
            }, 120000); // Refresh every 2 minutes
            isAutoRefreshUserBetsEnabled = true;
        }
        
        // Stop automatic refresh for user bets
        function stopAutoRefreshUserBets() {
            if (autoRefreshUserBetsInterval) {
                clearInterval(autoRefreshUserBetsInterval);
                autoRefreshUserBetsInterval = null;
            }
            isAutoRefreshUserBetsEnabled = false;
        }

        // Get live war data from API cache
        function getLiveWarData(warId) {
            try {
                const liveData = localStorage.getItem('liveWarData');
                if (!liveData) return null;
                
                const parsed = JSON.parse(liveData);
                if (!parsed.data || !parsed.data[warId]) return null;
                
                // Check if data is fresh (less than 5 minutes old)
                const dataAge = Date.now() - parsed.timestamp;
                if (dataAge > 5 * 60 * 1000) { // 5 minutes
                    console.log('Live war data is stale, will refresh on next update');
                }
                
                return parsed.data[warId] || null;
            } catch (error) {
                console.error('Error getting live war data:', error);
                return null;
            }
        }

        // Get war status text and class
        function getWarStatus(warData) {
            if (!warData || !warData.war) return 'Unknown';
            
            const now = Math.floor(Date.now() / 1000);
            const startTime = warData.war.start;
            const endTime = warData.war.end;
            
            if (endTime > 0) {
                return 'Finished';
            } else if (now < startTime) {
                return 'Upcoming';
            } else {
                return 'Active';
            }
        }

        // Refresh live war data from API (disabled - no external connections)
        async function refreshLiveWarData() {
            console.log(' Live war data refresh disabled - no external connections');
            // Function disabled to prevent API calls to non-existent endpoints
        }

        // Get live scores for the war
        function getLiveScores(warData, userFactionId) {
            if (!warData || !warData.factions) {
                return '<div class="user-bet-scores"> Fetching live data...</div>';
            }
            
            const factions = Object.entries(warData.factions);
            if (factions.length !== 2) {
                return '<div class="user-bet-scores">Invalid war data</div>';
            }
            
            const [faction1Id, faction1Data] = factions[0];
            const [faction2Id, faction2Data] = factions[1];
            
            const isUserFaction1 = faction1Id === userFactionId.toString();
            const userFaction = isUserFaction1 ? faction1Data : faction2Data;
            const opponentFaction = isUserFaction1 ? faction2Data : faction1Data;
            
            const userScore = userFaction.score || 0;
            const opponentScore = opponentFaction.score || 0;
            const target = warData.war.target || 0;
            
            // Calculate lead percentages (target is the lead difference)
            const scoreDifference = Math.abs(userScore - opponentScore);
            const userLead = userScore > opponentScore ? scoreDifference : 0;
            const opponentLead = opponentScore > userScore ? scoreDifference : 0;
            
            const userProgress = target > 0 ? Math.min((userLead / target) * 100, 100) : 0;
            const opponentProgress = target > 0 ? Math.min((opponentLead / target) * 100, 100) : 0;
            
            return `
                <div class="user-bet-scores">
                    <div class="user-bet-score-row">
                        <div class="user-bet-score-faction user-faction">
                            <span class="user-bet-score-name">${userFaction.name}</span>
                            <span class="user-bet-score-value">${userScore.toLocaleString()}</span>
                        </div>
                        <div class="user-bet-score-progress">
                            <div class="user-bet-progress-bar">
                                <div class="user-bet-progress-fill" style="width: ${userProgress}%; background: #059669;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-bet-score-row">
                        <div class="user-bet-score-faction opponent-faction">
                            <span class="user-bet-score-name">${opponentFaction.name}</span>
                            <span class="user-bet-score-value">${opponentScore.toLocaleString()}</span>
                        </div>
                        <div class="user-bet-score-progress">
                            <div class="user-bet-progress-bar">
                                <div class="user-bet-progress-fill" style="width: ${opponentProgress}%; background: #dc2626;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-bet-target">
                        <span class="user-bet-target-label">Lead Target:</span>
                        <span class="user-bet-target-value">${target.toLocaleString()}</span>
                    </div>
                    
                    <div class="user-bet-lead-info">
                        <span class="user-bet-lead-info-text">${userLead > 0 ? `Your faction leads by ${userLead.toLocaleString()}` : opponentLead > 0 ? `Opponent leads by ${opponentLead.toLocaleString()}` : 'Scores are tied'}</span>
                    </div>
                    
                    <div class="user-bet-live-timestamp">
                        <span class="user-bet-live-timestamp-text"> Live data updated: ${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
        }

        // Show user notification
        function showUserNotification(title, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">${title}</div>
                <div style="font-size: 0.9rem;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function fetchFactionRespectData(uniqueFactionIds) {
            console.log('Fetching enhanced faction data for', uniqueFactionIds.size, 'factions...');
            
            // Initialize enhanced data object
            const factionEnhancedData = {};
            
            // Load local faction data
            let localFactionData = {};
            try {
                console.log('Loading local faction data...');
                console.log(' Local faction data loading disabled - no external connections');
                const localResult = { factions: [] };
                
                if (localResult.factions) {
                    // Convert array to object for easier lookup
                    localFactionData = localResult.factions.reduce((acc, faction) => {
                        acc[faction.id] = faction;
                        return acc;
                    }, {});
                    console.log(`Loaded ${Object.keys(localFactionData).length} factions from local data`);
                } else {
                    console.warn('Failed to load local faction data');
                }
            } catch (error) {
                console.warn('Error loading local faction data:', error);
            }
            
            // Use only local data to avoid rate limiting
            Array.from(uniqueFactionIds).forEach((factionId) => {
                const localData = localFactionData[factionId] || {};
                
                factionEnhancedData[factionId] = {
                    chain: 0, // Default to 0 to avoid API calls
                    respect: localData.respect || null,
                    rank: localData.rank || null,
                    members: localData.members || null,
                    position: localData.position || null
                };
            });
            
            console.log('Fetched enhanced faction data from local data:', factionEnhancedData);
            console.log('Total factions with enhanced data:', Object.keys(factionEnhancedData).length);
            console.log('Sample enhanced data:', Object.entries(factionEnhancedData).slice(0, 3));
            
            // Log factions with respect data
            const factionsWithRespect = Object.entries(factionEnhancedData)
                .filter(([id, data]) => data.respect !== null)
                .length;
            console.log(`Factions with respect data: ${factionsWithRespect}/${Object.keys(factionEnhancedData).length}`);
            
            return factionEnhancedData;
        }

        // Bet Tracking Functions
        let allBets = [];
        let filteredBets = [];
        let betTrackingActive = false;

        // Toggle bet tracking section
        function toggleBetTracking() {
            const content = document.getElementById('bet-tracking-content');
            const toggle = document.querySelector('.bet-tracking-toggle');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                toggle.textContent = ' Show Tracking';
                betTrackingActive = false;
            } else {
                content.classList.add('active');
                toggle.textContent = ' Hide Tracking';
                betTrackingActive = true;
                loadBetData();
            }
        }

        // Load bet data
        async function loadBetData() {
            try {
                // Get bets from localStorage (shared with betting interface)
                const storedBets = localStorage.getItem('tornBets');
                if (storedBets) {
                    allBets = JSON.parse(storedBets);
                } else {
                    allBets = [];
                }
                
                filteredBets = [...allBets];
                updateBetStats();
                updateBetTable();
                updateBetFilters();
                
            } catch (error) {
                console.error('Error loading bet data:', error);
            }
        }

        // Update bet statistics
        function updateBetStats() {
            const stats = {
                total: allBets.length,
                totalVolume: allBets.reduce((sum, bet) => sum + bet.betAmount, 0),
                active: allBets.filter(bet => bet.status === 'confirmed').length,
                pending: allBets.filter(bet => bet.status === 'pending').length,
                won: allBets.filter(bet => bet.status === 'won').length,
                lost: allBets.filter(bet => bet.status === 'lost').length,
                totalPayouts: allBets.filter(bet => bet.status === 'won').reduce((sum, bet) => sum + calculatePayoutAmount(bet), 0),
                totalProfit: allBets.filter(bet => bet.status === 'won').reduce((sum, bet) => sum + calculatePayoutAmount(bet), 0) - 
                            allBets.filter(bet => bet.status === 'lost').reduce((sum, bet) => sum + bet.betAmount, 0)
            };

            document.getElementById('total-bets').textContent = stats.total;
            document.getElementById('total-volume').textContent = `$${(stats.totalVolume / 1000000).toFixed(1)}M`;
            document.getElementById('active-bets').textContent = stats.active;
            document.getElementById('won-bets').textContent = stats.won;
            document.getElementById('lost-bets').textContent = stats.lost;
            document.getElementById('total-payouts').textContent = `$${(stats.totalPayouts / 1000000).toFixed(1)}M`;
            document.getElementById('total-profit').textContent = `$${(stats.totalProfit / 1000000).toFixed(1)}M`;
        }

        // Update bet table
        function updateBetTable() {
            const tbody = document.getElementById('bet-table-body');
            
            if (filteredBets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">
                            <div style="font-size: 1.1rem; margin-bottom: 8px;"> No bets found</div>
                            <div style="font-size: 0.9rem;">Place some bets to see them here!</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredBets.map(bet => {
                const payoutAmount = calculatePayoutAmount(bet);
                const profit = bet.status === 'won' ? payoutAmount - bet.betAmount : 
                              bet.status === 'lost' ? -bet.betAmount : 0;
                const betMessage = generateBetMessageFromData(bet);
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">${bet.playerId}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">ID: ${bet.playerId}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">War ${bet.warId}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${formatTimestamp(bet.timePlaced)}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">Faction ${bet.factionId}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${bet.xanaxAmount} Xanax</div>
                        </td>
                        <td>
                            <div class="bet-amount">$${(bet.betAmount / 1000000).toFixed(1)}M</div>
                        </td>
                        <td>
                            <div style="font-size: 0.8rem; color: #64748b;">${formatTimestamp(bet.timePlaced)}</div>
                        </td>
                        <td>
                            <span class="bet-status-badge bet-status-${bet.status}">${bet.status}</span>
                        </td>
                        <td>
                            <div class="bet-payout">${bet.status === 'won' ? `$${(payoutAmount / 1000000).toFixed(1)}M` : '-'}</div>
                        </td>
                        <td>
                            <div class="bet-profit ${profit > 0 ? 'positive' : profit < 0 ? 'negative' : 'neutral'}">
                                ${profit > 0 ? '+' : ''}$${(profit / 1000000).toFixed(1)}M
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-family: 'DM Sans', monospace; font-size: 0.8rem; color: #374151; background: #f8fafc; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${betMessage}">${betMessage}</div>
                                <button class="bet-action-btn view" onclick="copyBetMessage('${bet.betId}')" title="Copy Bet Message"></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update bet filters
        function updateBetFilters() {
            const warFilter = document.getElementById('bet-war-filter');
            const uniqueWars = [...new Set(allBets.map(bet => bet.warId))];
            
            warFilter.innerHTML = '<option value="">All Wars</option>' + 
                uniqueWars.map(warId => `<option value="${warId}">War ${warId}</option>`).join('');
        }

        // Clear bet filters
        function clearBetFilters() {
            document.getElementById('bet-status-filter').value = '';
            document.getElementById('bet-war-filter').value = '';
            filteredBets = [...allBets];
            updateBetTable();
        }


        // Scroll-based header hiding functionality
        let lastScrollTop = 0;
        let scrollThreshold = 50; // pixels to scroll before hiding header
        
        function handleScroll() {
            const dashboardContent = document.querySelector('.dashboard-content');
            const dashboardHeader = document.querySelector('.dashboard-header');
            
            if (!dashboardContent || !dashboardHeader) return;
            
            const scrollTop = dashboardContent.scrollTop;
            const isScrollingDown = scrollTop > lastScrollTop;
            const hasScrolledEnough = scrollTop > scrollThreshold;
            
            if (isScrollingDown && hasScrolledEnough) {
                dashboardHeader.classList.add('hidden');
            } else if (scrollTop <= scrollThreshold) {
                dashboardHeader.classList.remove('hidden');
            }
            
            lastScrollTop = scrollTop;
        }
        
        // Add scroll event listener when dashboard is shown
        function setupScrollListener() {
            const dashboardContent = document.querySelector('.dashboard-content');
            if (dashboardContent) {
                dashboardContent.addEventListener('scroll', handleScroll);
            }
        }
        
        // Set up bet filter event listeners
        document.addEventListener('DOMContentLoaded', function() {
        // Clear any cached data to ensure fresh data
        if (typeof bettingCache !== 'undefined') {
            bettingCache.clear();
            console.log(' Cleared all cached data on page load');
        }
        
        // Detect and log user's timezone
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        console.log(' User timezone detected:', userTimezone);
        
        // Check for existing API key on page load
        checkExistingApiKey();
            
            // Add event listeners for bet filters
            const statusFilter = document.getElementById('bet-status-filter');
            const warFilter = document.getElementById('bet-war-filter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', filterBets);
            }
            if (warFilter) {
                warFilter.addEventListener('change', filterBets);
            }
            
            // Setup scroll listener for tab hiding
            setupScrollListener();
        });

        // Filter bets based on current filters
        function filterBets() {
            const statusFilter = document.getElementById('bet-status-filter')?.value;
            const warFilter = document.getElementById('bet-war-filter')?.value;
            
            filteredBets = allBets.filter(bet => {
                const statusMatch = !statusFilter || bet.status === statusFilter;
                const warMatch = !warFilter || bet.warId === warFilter;
                
                return statusMatch && warMatch;
            });
            
            updateBetTable();
        }

        // FAQ Functionality
        function initializeFAQ() {
            const faqItems = document.querySelectorAll('.faq-item h4');
            
            faqItems.forEach(item => {
                item.addEventListener('click', function() {
                    const faqItem = this.parentElement;
                    const content = faqItem.querySelector('.faq-content');
                    
                    // Toggle active class
                    faqItem.classList.toggle('active');
                    
                    // Toggle content visibility
                    if (faqItem.classList.contains('active')) {
                        content.style.display = 'block';
                        // Smooth scroll to content if it's not visible
                        setTimeout(() => {
                            content.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'nearest' 
                            });
                        }, 100);
                    } else {
                        content.style.display = 'none';
                    }
                });
            });
        }

        // Initialize FAQ when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Existing DOMContentLoaded code...
            
            // Initialize FAQ functionality
            initializeFAQ();
        });
    </script>
</body>
</html> 